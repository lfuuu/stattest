<script src="js/jquery.inputmask.js"></script>

<div style="font-size: 18px; padding 5px; margin-bottom: 10px;">
    <div style="width: 50%; display: inline-block;">
        {if access('clients','edit')}
            <a href='{$LINK_START}module=clients&id={$client.super_id}&action=client_edit' title="Редактировать (супер) клиента">
                <img src='{$IMAGES_PATH}icons/edit.gif'>
            </a>
        {/if}
        
        {$superClient.name} &nbsp;&nbsp;
        {php} if (defined("CORE_SERVER") && CORE_SERVER): {/php}
        <a style="font: normal 7pt sans-serif;" target=_blank href="https://{php}echo CORE_SERVER;{/php}/core/support/login_under_core_admin?stat_client_id={$client.super_id}">
            Переход в LK
        </a>
        {php} endif; {/php}
    </div>
    <div style="width: 45%; display: inline-block; text-align: right; padding-right: 10px; font: normal 12pt sans-serif;">
        {if false && $superClient.accountManager}
        <span style="{if $superClient.accountManager && $superClient.accountManager.color}background-color: {$superClient.accountManager.color}{/if}">Аккаунт менеджер: {$superClient.accountManager.name}</span>
        {/if}
    </div>
</div>
<div style="clear: both;"></div>

{foreach from=$contragents item='contragent'}
<div style="border-top: 1px solid #bbb; padding: 3px; margin: 10px 0">
    <div style="color: #333;min-width: 500px; display: inline-block;">
        <a href='/contragent/edit?id={$contragent.id}' title="Редактировать контрагента">
            <img src='{$IMAGES_PATH}icons/edit.gif'>
        </a>
        <span {if $clientAccount.contragent_id==$contragent.id}style="font-weight: bold"{/if}>{$contragent.name}</span>
    </div>
    <div style="display: inline-block;">  
        <small>{$client.address_post}</small>
    </div>
    {foreach from=$contragent.accounts item='account'}
        <div style="display: inline-block; padding: 0 4px;display: block; color: #333; border: 1px solid #bbb; border-radius: 5px; padding: 3px; margin: 5px 0; background-color: {if $account.id==$clientAccount.id}#ddd{else}#f2f2f2{/if};">
            {if $account.id==$clientAccount.id}<b>{/if}
            <div style="display: inline-block; min-width: 70px">
                 {if access('clients','edit')}
                     <div style="display: inline-block;">
                         <a href='{$LINK_START}module=clients&id={$account.id}&action=edit' title="Редактировать лицевой счет">
                             <img src='{$IMAGES_PATH}icons/edit.gif' style="valign: top;">
                         </a>
                     </div>
                 {/if}
                 <div style="display: inline-block; color: {if $account->is_active}green{else}black{/if};" title="{$account.client}">{$account.id}</div>
             </div>
             <a class="nohover" href="?module=clients&id={$account.id}" style="">
                 <div style="display: inline-block; min-width: 200px">
                     {$account.contractType.name} / {$account.firma} / 
                     <span{if $account.statusBP.color} style="background-color: {$account.statusBP.color}"{/if}>{$account.statusBP.name}</span>
                 </div>
                 <div style="display: inline-block; min-width: 20px"></div>
                 <div style="display: inline-block; min-width: 200px">
                     <span {if $account.balance > 0}style="color: green"{elseif $account.balance < 0}style="color: red"{/if}>
                         {math equation="-(balance)" balance=$account.balance} {$account.currency}
                     </span>
                     {if $account.credit >= 0}<span style='font-size:85%'>(кредит {$account.credit})</span>{/if}
                 </div>
                 <div style="display: inline-block; min-width: 120px">
                     {if $account.accountRegion}{$account.accountRegion.name}{/if}
                 </div>
                 <div style="display: inline-block; min-width: 260px; padding: 1px 5px;{if $account.manager && $account.userManager.color}background-color: {$account.userManager.color}{/if}">
                     {if $account.manager}Менеджер: {$account.userManager.name}{/if}
                 </div>
                 
                 {if $account.account_manager}
                     <div style="display: inline-block; min-width: 260px; padding: 1px 5px;{if $account.userAccountManager.color}background-color: {$account.userAccountManager.color}{/if}">
                         Ак.Менеджер: {$account.userAccountManager.name}
                     </div>
                 {/if}

                 {if $account.id==$clientAccount.id}</b>{/if}
                 <div style="display: inline-block;">
                     {if $account.lastComment}
                         {foreach from=$account.lastComment item=comment}
                             {$comment.user} {$comment.ts|udate|substr:0:10} {$comment.comment}<br>
                         {/foreach}
                     {/if}
                 </div>
             </a>
         </div>
    {/foreach}
</div>
{/foreach}


<div style="width: 250px; float: right" id="right_menu">
    {if access('tt','r')}<a href='{$LINK_START}module=tt&action=all'><img class=icon src='{$IMAGES_PATH}icons/tt.gif'>Посмотреть заявки</a> (всего: <b>{$troubles_total}</b>{if $troubles_opened>0}, <font color=red>из них незакрытых: <b>{$troubles_opened}</b></font>{/if})<br><br>{/if}
    {if access('clients','edit') || access('clients','edit_tele')}
    <a href='{$LINK_START}module=clients&id={$client.id}&action=edit' title="Редактировать лицевой счет">
        <img class=icon src='{$IMAGES_PATH}icons/edit.gif'>Редактировать ЛС
    </a>
    <br><br>
    <a href='{$LINK_START}module=clients&id={$client.id}&action=print&data=envelope' target='_blank'>
        <img class=icon src='{$IMAGES_PATH}icons/envelope.gif'>Напечатать конверт
    </a>
    <br><br>
    {if access('clients','file')}
    <a href="{$LINK_START}module=clients&action=files&cid={$client.id}">
        <img class=icon src='{$IMAGES_PATH}icons/contract.gif'>Файлы
    </a> ({$cfiles} шт.)
    <br><br>
    {/if}
    {/if}


    <br>
    <br>

    {if !$client.is_closed}
    {if access('clients','all4net')}
    <br /><br />
    <a href='?module=newaccounts&action=make_1c_bill&tty=mounting_orders'><img src="./images/icons/printer.gif" border=0> Создать заказ на Установку/Монтаж</a><br />
    <br>
    <a href='?module=newaccounts&action=make_1c_bill&tty=shop_orders'><img src="./images/icons/add.gif" border=0>Создать заказ из Магазина</a><br />
    <br>
    <a href='?module=newaccounts&action=make_1c_bill&tty=shop_orders&is_rollback=1'><img src="./images/icons/disable.gif" border=0> Возврат товара</a><br />
    <br>
    {/if}

    {if access('incomegoods','admin')}
    <br/>
    <a href='?module=incomegoods&action=order_edit&id='><img src="./images/icons/add.gif" border=0>Создать заказ Поставщику</a>
    <br/><br/><br/>
    {/if}
    {/if} {* if !$client.is_closed *}
    
    <a href="?module=tt&action=view_type&type_pk=2&show_add_form=true">Создать задание</a><br />
    <br>
    {if !$client.is_closed}
    <a href="?module=tt&action=view_type&type_pk=1&show_add_form=true">Создать заявку на поддержку</a>

    {*if access('clients','yota')*}
    <br /><br />
    <a href='{$LINK_START}module=clients&action=print_yota_contract' target='_blank' id='YotaContractLink' style='display:none'>Печатать договор Yota</a>
    <script type='text/javascript'>
        if(!document.all && window.navigator.appName != "Opera")
            document.getElementById('YotaContractLink').style.display = 'block';
    </script>
    {*/if*}

    <br> <a href="./?module=clients&id={$client.id}&sync=true">Синхронизовать с ЛК</a>

    <hr />
    <a href="/transfer/index/?client={$client.id}" class="dialog" data-dialog="transfer">Перенос услуг</a>
    {/if} {* if !$client.is_closed *}
</div>

<div style="margin-right: 260px;" id="cl_main_div">
<table class="table table-condensed table-striped" width="100%">

{if $client.previous_reincarnation}
<tr>
    <td align="right"{if $client.nal!='beznal'} style='background-color:{if $client.nal=="nal"}#ffc0c0{else}#c0c0ff{/if}'{/if} width='30%'>Предыдущие реквизиты:</td>
    <td><a href="?module=clients&id={$client.previous_reincarnation}">{$client.prev_r_cl}</a></td>
</tr>
{/if}

{if false}
<tr>
    <td class="cl_main_col1" align="right"{if $client.nal!='beznal'} style='background-color:{if $client.nal=="nal"}#ffc0c0{else}#c0c0ff{/if}'{/if}>
    <a href='javascript:toggle2("company_names");'><img class=icon src='{$IMAGES_PATH}icons/edit.gif' alt="Посмотреть"></a>Компания:
    </td>
    <td class="cl_main_col2" {if $client.nal!='beznal'} style='background-color:{if $client.nal=="nal"}#ffc0c0{else}#c0c0ff{/if}'{/if}>
    <b>{$client.company_full}</b>&nbsp; &nbsp;{if trim($client.company_full)!= trim($client.company)}({$client.company}){/if}&nbsp; &nbsp;(<span style='color:#000080'>{$client.firma}</span>)
    </td>
</tr>
<tr id=company_names style="display: none;">
    <td colspan=2 align=center>
        Изменения названия компании:
        <table style="background-color: gray;" cellspacing=1 cellpadding=3>
            <tr><td><b>Дата</td><td><b>Пользователь</td><td><b>Полное названия</b></td><td><b>Краткое</b></td></tr>
            {foreach from=$log_company item=l}
            <tr><td>{$l.ts|udate}</td><td>{$l.user}</td><td>{$l.company.company_full.to}</td><td>{$l.company.company.to}</td></tr>
            {foreachelse}
            <tr><td colspan=4 align=center><i>Нет изменений</i></td></tr>
            {/foreach}
        </table>

    </td>
</tr>
{/if} {* end if false *}
<tr>
    <td align="right" {if $clientAccount.statusBP.color} style='background-color:{$clientAccount.statusBP.color}'{/if}>
    Статус:
    </td>
    <td {if $clientAccount.statusBP.color} style='background-color:{$clientAccount.statusBP.color}'{/if}>
    <b>{$clientAccount.statusBP.name}</b>&nbsp;&nbsp;<a href='javascript:togglecs();'><img class=icon src='{$IMAGES_PATH}icons/monitoring.gif' alt="Посмотреть"></a>
    {include file="clients/wizard.htm"}
    </td>
</tr>

<tr {if !$user_flag_statusbox}style='display:none' {/if}id=data_cs1>
<td colspan=2 align="center">
    <div style="display: inline-block; text-align: left">
        {foreach from=$client.data_cs item=item name=outer}
            {if $item.comment}
                <input type=checkbox name="publich_contact_id" value="{$item.id}" class="publish_comment{if $item.is_publish}_over{/if}"{if $item.is_publish} checked{/if}>
                <b>{$item.user} {$item.ts|udate}</b>: {$item.comment}<br>
            {/if}
            {if $item.status}
                <div style="width: 17px; display: inline-block;">&nbsp;</div><b>{$item.user} {$item.ts|udate}</b>: статус изменён на {$item.status}<br>
            {/if}
            {/foreach}
            <script>
                optools.client.initChoiseLastComment({$client.id});
            </script>
    </div>
</td>
</tr>
{if !access("clients", "client_type_change") && $client.is_blocked}
<tr>
    <td align=right valign=top style="padding-top: 14px;">
        Блокировка:
    </td>
    <td>
        <button type="button" class="btn btn-default btn-danger" style="width: 130px;">Заблокирован</button>
    </td>
</tr>

{/if}

{if !access('clients','restatus') || !access("clients", "client_type_change")}
<tr>
    <td align="right">Тип договора:</td>
    <td>
        {foreach from=$contract_types item=item}
            {if ($item.id == $client.contract_type_id)}{$item.name}{/if}
        {/foreach}
    </td>
</tr>
<tr>
    <td align="right">Бизнес процес:</td>
    <td>
        {foreach from=$bussines_processes item=item}
            {if ($item.id == $client.business_process_id)}{$item.name}{/if}
        {/foreach}
    </td>
</tr>
    {if $client.is_closed}
    <tr>
        <td align="right">Статус бизнес процесса:</td>
        <td>
            {foreach from=$business_process item=item}
                {if ($item.id == $client.business_process_status_id)}{$item.name}{/if}
            {/foreach}
        </td>
    </tr>
    {/if}
{/if}

{if access('clients','restatus')}
<tr>
    <td colspan="2" align="center">
        <form action="?" method=post id=sform name=sform>
        <input type=hidden name=module value=clients>
        <input type=hidden name=action value=restatus>
        <input type=hidden name=id value='{$client.id}'>
        <table width=80%>
            <tr>
    {if access("clients", "client_type_change")}
    <td valign=top>
        
        <table width=100%>
            <tr {if !$user_flag_statusbox}style='display:none' {/if}id=data_cs7>
                <td align="right">Тип договора:</td>
                <td>
                    <SELECT class="select2" style="width: 240px" name=contract_type_id id=contract_type_id>{foreach from=$contract_types item=item}<option value='{$item.id}' {if ($item.id == $client.contract_type_id)} selected{/if}>{$item.name}</option>{/foreach}</select>
                </td>
            </tr>
            <tr {if !$user_flag_statusbox}style='display:none' {/if}id=data_cs6>
                <td align="right">Бизнес процес:</td>
                <td>
                        <SELECT class="select2" style="width: 240px" name=business_process_id id=business_process_id>{foreach from=$bussines_processes item=item}<option value='{$item.id}' {if ($item.id == $client.business_process_id)} selected{/if}>{$item.name}</option>{/foreach}</select>

                </td>
            </tr>
            {if !$client.is_closed}
                <tr>
                    <td align="right">
                        Блокировка:
                    </td>
                    <td>
                        <div class="btn-group" role="group" aria-label="...">
                            <button id="block-btn-work" type="button" class="btn btn-default btn-sm {if $client.is_blocked}btn-default{else}btn-success{/if}" style="width: 120px;">Работает</button>
                            <button id="block-btn-block" type="button" class="btn btn-default btn-sm dropdown-toggle {if $client.is_blocked}btn-danger{else}btn-default{/if}" style="width: 120px;" data-toggle="dropdown" aria-expanded="false">Заблокирован</button>
                        </div>
                    </td>
                </tr>
            {/if}
        </table>

        <script>
            optools.client.initBlocked({$client.id});
            optools.client.contractTypeSwitch.init();
        </script>
    </td>
    {/if}
        {if !$client.is_closed || access("clients", "client_type_change")}
        <td valign=top>
            <table width="100%">
                <tr>
                    <td align="right">Статус бизнес процесса:</td>
                    <td>
                        <SELECT class="select2" style="width: 200px" name=business_process_status_id id=business_process_status_id>
                            {foreach from=$business_process item=item}
                                <option value='{$item.id}' {if ($item.id == $client.business_process_status_id)} selected{/if}>{$item.name}</option>
                            {/foreach}
                        </select>
                    </td>
                </tr>

                <tr>
                    <td align="right">Комментарий:</td>
                    <td>
                        <div style="position: relative"><textarea style='width:90%; height:100px' name=comment class=text></textarea></div>
                    </td>
                    </tr>
                    <tr>
                    <td align="right" style='border-bottom:1 solid red'>&nbsp;</td>
                    <td style='border-bottom:1 solid red'>
                        <input class=text value='Изменить' type=submit>
                    </td>
                </tr>
            </table>
        </td>
        {/if}
    </tr>
</table>

    </td>
</tr>
</form>
{/if}
<tr>
    <td align="right">Предполагаемый <b>адрес</b> подключения:</td>
    <td>{$client.address_connect}{if $client.phone_connect} <b>телефон:</b> {$client.phone_connect}{/if}</td>
</tr>

<tr id="contact_header1" style="display: none;">
    <td align="right">
        <a href='javascript:toggle2("contact");toggle2("contact_header1");toggle2("contact_header2");toggle2("contact_fax");toggle2("contact_email");toggle2("contact_sms");'><img class=icon src='{$IMAGES_PATH}icons/monitoring.gif' alt="Изменить"></a>
        Контакты:
    </td>
    <td colspan=2 id="contact_phone">
        &nbsp;
    </td>
</tr>
<tr id="contact_header2">
    <td align="right">
        <a href='javascript:toggle2("contact");toggle2("contact_header1");toggle2("contact_header2");toggle2("contact_fax");toggle2("contact_email");toggle2("contact_sms");'><img class=icon src='{$IMAGES_PATH}icons/monitoring.gif' alt="Изменить"></a>
        Телефон:
    </td>
    <td colspan=2>
        {foreach from=$contact.phone item=item name=inner}
        {if $smarty.foreach.inner.iteration!=1}; {/if}
        <span {if $item.is_official} style='font-weight:bold'{/if}>{$item.data}</span> - {$item.comment|escape}
        {/foreach}
    </td>
</tr>
{if count($contact.fax)}
<tr id="contact_fax">
    <td align="right">Факс:</td>
    <td colspan=2>
        {foreach from=$contact.fax item=item name=inner}
        {if $smarty.foreach.inner.iteration!=1}; {/if}
        <span {if $item.is_official} style='font-weight:bold'{/if}>{$item.data}</span> - {$item.comment|escape}
        {/foreach}
    </td>
</tr>
{/if}
{if count($contact.email)}
<tr id="contact_email">
    <td align="right">E-mail:</td>
    <td colspan=2>
        {foreach from=$contact.email item=item name=inner}
        {if $smarty.foreach.inner.iteration!=1}; {/if}
        <a{if $item.is_official} style='font-weight:bold'{/if} target=_blank href="http://thiamis.mcn.ru/welltime/?module=com_agent_panel&frame=new_msg&nav=mail.none.none&message=none&trunk=5&to={$item.data}" title="{$item.comment|escape}">{$item.data}</a>
        <a{if $item.is_official} style='font-weight:bold'{/if} href="mailto:{$item.data}">(@)</a>
        {/foreach}
    </td>
</tr>
{/if}
{if isset($contact.sms) && count($contact.sms)}
<tr id="contact_sms">
    <td align="right">СМС:</td>
    <td colspan=2>
        {foreach from=$contact.sms item=item name=inner}
        {if $smarty.foreach.inner.iteration!=1}; {/if}
        <span{if $item.is_official} style='font-weight:bold'{/if}>{$item.data}</span> - {$item.comment|escape}
        {/foreach}
    </td>
</tr>
{/if}

<tr id=contact style="display: none">
    <td colspan=3 align="center">
        <form action="?" method=post>
            <input type=hidden name=module value=clients>
            <input type=hidden name=action value=recontact>
            <input type=hidden name=id value='{$client.id}'>

            <table class=insblock cellspacing=4 cellpadding=2 border=0>
                <tr>
                    <th>тип</th>
                    <th></th>
                    <th>контакт</th>
                    <th>комментарий</th>
                    <th>кто</th>
                    <th>когда</th>
                    <th>&nbsp;</th>
                </tr>
                {foreach from=$contacts item=item}
                <tr {if !$item.is_active} class="other"{/if}>
                <td{if $item.is_official} style='font-weight:bold'{/if}>
                {if $item.type=='phone'}телефон{elseif $item.type=='fax'}факс{elseif $item.type=='email'}e-mail{elseif $item.type=='sms'}СМС{/if}
                </td>
                <td>
                    {if $card_type == "main" && $item.type == "email" && $item.is_official && $item.is_active}
                    <input type=radio value="{$item.id}" name="admin_contact"{if $client.admin_contact_id == $item.id} checked{/if}>
                    {/if}
                </td>
                <td>{$item.data}</td>
                <td>{$item.comment}</td>
                <td>{$item.user}</td>
                <td style='font-size:70%'>{$item.ts|udate}</td>
                <td>
                    {if !$client.is_closed}
                    {if $item.user == 'AutoLK'}
                    <a href='{$LINK_START}module=clients&id={$item.client_id}&action=recontactLK&act={if $lk_contacts[$item.id] == "connecting"}working{else}connecting{/if}&cid={$item.id}'><img style='margin-left:-2px;margin-top:-3px' class=icon src='{$IMAGES_PATH}icons/{if $lk_contacts[$item.id] == "connecting"}action_check_off{else}action_check{/if}.gif' alt="Активность"></a>
                    {else}
                    <a href='{$LINK_START}module=clients&id={$item.client_id}&action=recontact2&act={if $item.is_active}0{else}1{/if}&cid={$item.id}'><img style='margin-left:-2px;margin-top:-3px' class=icon src='{$IMAGES_PATH}icons/{if $item.is_active}delete{else}add{/if}.gif' alt="Активность"></a>
                    {/if}
                    {/if} {* is active *}
                </td>
                </tr>
                {/foreach}

                {if !$client.is_closed}
                <tr>
                    <td>
                        <select name=type class=text style='font-size:10px' id='cd_type'>
                            <option value='phone'>телефон</option>
                            <option value='fax'>факс</option>
                            <option value='email'>e-mail</option>
                            <option value='sms'>СМС</option>
                        </select>
                        <input type=checkbox class=text name=official title="официальный?">
                    </td>
                    <td></td>
                    <td><input class=text style='width:100%' type=text name=data id='i_cd_data'></td>
                    <td colspan=2><input class=text style='width:100%' type=text name=comment></td>
                    <td><input class=button type=submit name="add_contact" value="добавить"></td>
                </tr>
                {if $card_type == "main"}
                <tr>
                    <td>&nbsp;</td>
                    <td>
                        <input type=radio name="admin_contact" title="Сбросить" value=0 {if $client.admin_contact_id == 0} checked{/if}>
                    </td>
                    <td colspan=4>
                        <input class=button type=submit name="set_admin" value="Администратор в LK">
                    </td>
                </tr>
                {/if}
                {/if} {* !$client.is_closed *}
            </table>
        </form>
    </td>
</tr>
<tr><td colspan="2" style="display: none"></td></tr>

{include file="clients/contract/main.htm"}

<tr><td colspan="2" style="display: none"></td></tr>
</table>
</div>

<script>
    {literal}

    function togglecs() {
        for(var i in [1,2,3,4,5,6,7])
        {
            i++;
            var d = document.getElementById("data_cs"+i);
            if (d) {
                toggle2(d);
            }
        }

        if (data_cs1.style.display==''){
            value = '1';
        } else {
            value = '0';
        }
        $.get("?module=usercontrol&action=ex_flag&flag=statusbox&value="+value);
    }

    {/literal}
</script>
