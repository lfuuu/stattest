<h1>
    <small>
        <a href="?module=voipreports&action=pricelist_report_list&report_type_id={$rep->report_type_id}">Отчеты</a>
    </small>

    Отчет: Анализ прайслистов:
    <small>{if $rep->instance_id}{php}echo $this->_tpl_vars['regions'][$this->_tpl_vars['rep']->instance_id]->name;{/php}{else}Все регионы{/if}

    ({foreach from=$rep->pricelist_ids key='i' item='pl'}
    {if $i > 0},{/if}
    {$pricelists[$pl]->name}
    {/foreach})
    </small>
</h1>

<p>
    {if $volume.calc_date}
    Объемы звонков рассчитаны с {$volume.date_from} по {$volume.date_to} ({if $volume.region_id}{$regions[$volume.region_id]->name}{else}Все регионы{/if})
    {if $volume.need_recalc == 't'}
    <b>(требуется пересчет)</b>
    {/if}
    {else}
    Объемы не рассчитаны
    {/if}
    {if $volume.calc_running == 't'}
    <b>(идет расчет)</b>
    {else}
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <a href="?module=voipreports&action=calc_volume&report_type=pricelist&report_id={$rep->id}"">Рассчет объемов</a>
    {/if}

    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

    <a href="?module=voipreports&action=pricelist_report_edit&id={$rep->id}">Настройка отчета</a>
</p>

{if $rep->generated_at}
<p>
    Отчет расчитан {$rep->generated_at}
</p>
{/if}

<style type="text/css">
    {literal}
    td.best {
        background-color:rgb(153, 247, 153);
    }
    {/literal}
</style>

<form action="./index.php" method="get" style="display:inline">
	<input type="hidden" name="module" value="voipreports" />
	<input type="hidden" name="action" value="pricelist_report_show" />
	<input type="hidden" name="id" value="{$report_id}" />

	<select name="f_country_id" class="select2" style="width: 250px">
	<option value="0">-- Все страны --</option>
	{foreach from=$countries item='g'}
	<option value="{$g.id}" {if $g.id eq $f_country_id} selected{/if}>{$g.name}</option>
	{/foreach}
	</select>
	<select name="f_region_id" class="select2" style="width: 300px">
	<option value="0">-- Все регионы --</option>
	{foreach from=$geo_regions item='g'}
	<option value="{$g.id}" {if $g.id eq $f_region_id} selected{/if}>{$g.name}</option>
	{/foreach}
	</select>

    <select name="f_mob">
        <option value="0">-- Моб/Стац --</option>
        <option value="t" {if $f_mob eq 't'} selected{/if}>Мобильные</option>
        <option value="f" {if $f_mob eq 'f'} selected{/if}>Стационарные</option>
    </select>

    <br/>

    <label><input type="checkbox" name="f_short" {if $f_short != ''} checked{/if}>Сократить</label>&nbsp;&nbsp;
	<input type=submit name="make" value="Сформировать"/>
    <input type=submit name="calc" value="Пересчитать"/>
	<input type=submit name="export" value="Выгрузить"/>
</form>

<table class=price cellSpacing=2 cellPadding=4 border=0>
<tr><td class=header colspan=3>&nbsp;</td>
    {if $showOperator}
    <td class=header>&nbsp;</td>
    {/if}
    <td nowrap class=header align=center>Лучшая цена</td>
    {foreach from=$rep->pricelist_ids key='i' item='p'}
		<td class=header align=center>{$pricelists[$p]->name}</td>
	{/foreach}
	{if $volume.calc_date}
        <td class=header align=center>Объем</td>
        {foreach from=$volumes key='instance_id' item='v'}
            <td  class=header align=center>Объем</td>
        {/foreach}
        {foreach from=$volumesByPricelist key='pricelist_id' item='v'}
            <td  class=header align=center>Объем</td>
        {/foreach}
    {/if}
</tr>
<tr><td class=header>Префикс номера</td><td class=header>Зона</td><td class=header>Назначение</td>
    {if $showOperator}
        <td class=header>Оператор</td>
    {/if}
    <td nowrap class=header align=center>{php}echo $this->_tpl_vars['regions'][$this->_tpl_vars['rep']->instance_id]->name;{/php}</td>
    {foreach from=$rep->pricelist_ids key='i' item='p'}
		<td class=header align=center>{$rep->dates[$i]}</td>
	{/foreach}
	{if $volume.calc_date}
        <td class=header align=center>(мин)</td>
        {foreach from=$volumes key='instance_id' item='v'}
            <td  class=header align=center>{$regions[$instance_id]->name}</td>
        {/foreach}
        {foreach from=$volumesByPricelist key='pricelist_id' item='v'}
            <td  class=header align=center>{$pricelists[$pricelist_id]->name}</td>
        {/foreach}
    {/if}
</tr>
{foreach from=$report item='rd'}

<tr class={cycle values='even,odd'}>
	<td>{$rd.prefix}</td>
	<td align=center>{$rd.zone}</td>
	<td>{$rd.destination}{if $rd.mob=='t'} (mob){/if}</td>
    {if $showOperator}
    <td>{if $rd.operator_id}
            {if $geoOperators[$rd.operator_id]}
                {$geoOperators[$rd.operator_id]}
            {else}
                Другой оператор
            {/if}
        {/if}
    </td>
    {/if}
    <td  align=center>{$rd.best_price|replace:'.':','}</td>
    {foreach from=$rep->pricelist_ids key='i' item='p'}
		<td align=center class="{if $rd.best_index == $i}best{/if}">{if $rd.prices[$i] != 'NULL'}{$rd.prices[$i]|replace:'.':','}{/if}</td>
	{/foreach}
	{if $volume.calc_date}
        <td align=center>{$rd.volume}</td>
        {foreach from=$volumes key='instance_id' item='v'}
            <td align=center>{$v[$rd.prefix].volume}</td>
        {/foreach}
        {foreach from=$volumesByPricelist key='pricelist_id' item='v'}
            <td align=center>{$v[$rd.prefix].volume}</td>
        {/foreach}
    {/if}
</tr>

{/foreach}
</table>
