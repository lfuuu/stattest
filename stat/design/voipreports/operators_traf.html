<form action="" method="get">
	<input type="hidden" name="module" value="voipreports" />
	<input type="hidden" name="action" value="operators_traf" />
	<table>
		<tr>
			<td>С</td>
			<td><select name="date_from_y" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y','date_from_m','date_from_d')">{generate_sequence_options_select start=2003 selected=$date_from_yy}</select></td>
			<td><select name="date_from_m" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y','date_from_m','date_from_d')">{generate_sequence_options_select start=1 end=12 mode='m' selected=$date_from_mm}</select></td>
			<td><select name="date_from_d" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y','date_from_m','date_from_d')">{generate_sequence_options_select start=1 end=31 mode='d' selected=$date_from_dd}</select></td>
			<td>&nbsp;</td>
			<td>По</td>
			<td><select name="date_to_y" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y','date_to_m','date_to_d')">{generate_sequence_options_select start=2003 selected=$date_to_yy}</select></td>
			<td><select name="date_to_m" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y','date_to_m','date_to_d')">{generate_sequence_options_select start=1 end=12 mode='m' selected=$date_to_mm}</select></td>
			<td><select name="date_to_d" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y','date_to_m','date_to_d')">{generate_sequence_options_select start=1 end=31 mode='d' selected=$date_to_dd}</select></td>
		</tr>
		<tr>
			<td>Транк</td>
			<td colspan="8">
				<select class="select2" style="width: 300px" name="trunk">
					<option value="0">Все</option>
					{foreach from=$trunks item='o'}
					<option value="{$o.id}"{if $trunk eq $o.id} selected='selected'{/if}>{$o.name} ({$o.id})</option>
					{/foreach}
				</select>
			</td>
		</tr>
		<tr>
			<td>Услуга транк</td>
			<td colspan="8">
				<select class="select2" style="width: 300px" name="serviceTrunk">
					<option value="0">Все</option>
					{foreach from=$serviceTrunks item='o'}
					<option value="{$o.id}"{if $serviceTrunk eq $o.id} selected='selected'{/if}>{$o.name} ({$o.id})</option>
					{/foreach}
				</select>
			</td>
		</tr>
		<tr>
			<td>Направление</td>
			<td colspan="8">
				<select name="destination">
					<!-- 1-MSK,2-MSK_MOB,3-RUSSIA,4-WORLD,9-INCALL -->
					<option value="all" {if $destination eq 'all'} selected='selected'{/if}>Все</option>
                    <option value="99"{if $destination eq '9'} selected='selected'{/if}>Местные</option>
                    <option value="10"{if $destination eq '10'} selected='selected'{/if}>Зона стационарные</option>
					<option value="11"{if $destination eq '11'} selected='selected'{/if}>Зона мобильные</option>
					<option value="101"{if $destination eq '101'} selected='selected'{/if}>Россия</option>
					<option value="102"{if $destination eq '102'} selected='selected'{/if}>Международное</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>Входящие/Исходящие</td>
			<td colspan="8">
				<select name="direction">
					<option value="both">Все</option>
					<option value="in"{if $direction eq 'in'} selected='selected'{/if}>Входящие</option>
					<option value="out"{if $direction eq 'out'} selected='selected'{/if}>Исходящие</option>
				</select>
			</td>
		</tr>
		<tr>
			<td>Группировка</td>
			<td colspan="8">
				<select name="groupp">
					<option value="0">По оператору</option>
					<option value="1"{if $groupp==1} selected='selected'{/if}>По дням</option>
					<option value="2"{if $groupp==2} selected='selected'{/if}>По месяцам</option>
				</select>
			</td>
			<td>Регион</td>
			<td colspan="8">
                <select class="select2" style="width: 200px" name="region">
                    <option value="0">Все</option>
                    {foreach from=$regions item='r'}
                    <option value="{$r.id}"{if $r.id eq $region} selected{/if}>{$r.name}</option>
                    {/foreach}
                </select>
			</td>
		</tr>
		<tr><td colspan="9"><input type="submit" name="get" value="Ok" /></td></tr>
	</table>
</form>

{if isset($report)}
{assign var='bg' value='#40c0ff'}{assign var='fg' value='black'}
<table class='price' cellSpacing='4' cellPadding='2'  border='0'>
	<tr>
		{if $groupp}<td class='header' vAlign='bottom' width="100">Дата</td>{/if}
		<td class='header' vAlign='bottom' width="110">Оператор</td>
		{foreach from=$report_dest item='dd' key='d'}
		{if $d<>'sum'}
		<td class='header' vAlign='bottom'  width="110">{if $d==9}Местные{elseif $d==10}Зона ст.{elseif $d==11}Зона моб.{elseif $d==100}7800{elseif $d==101}Россия{elseif $d==102}Международные{elseif $d==900}Сумма</td><td class='header' vAlign='bottom' width="110">Входящие{/if}</td>
		{/if}
		{/foreach}
	</tr>
	{assign var='co' value='0'}
	{foreach from=$report item='o' key='operator'}
	{if $groupp}
	{if $co<>'0'}
	<tr>
		<td colspan="2" class="header" style="background-color: {$bg}; color: {$fg};">Итого по оператору {$operators[$co]}:</td>
		{foreach from=$report_dest item='rd' key='dkey'}
		{if $dkey<>'sum'}
		{if isset($report_oper[$co][$dkey])}
			{if $dkey<>900}
				<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>
					{"`$report_oper[$co][$dkey].clean/60`"|round:2} минут<br />{$report_oper[$co][$dkey].human}<br />стоимость: {$report_oper[$co][$dkey].price}</td>
			{else}
				<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co].sum.clean/60`"|round:2} минут<br />{$report_oper[$co].sum.human}<br />стоимость: {$report_oper[$co].sum.price}</td>
                <td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co][$dkey].clean/60`"|round:2} минут<br />{$report_oper[$co][$dkey].human}<br />стоимость: {$report_oper[$co][$dkey].price}</td>
			{/if}
		{elseif $dkey==900}
			<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co].sum.clean/60`"|round:2} минут<br />{$report_oper[$co].sum.human}<br />стоимость: {$report_oper[$co].sum.price}</td><td>&mdash;</td>
		{else}
			<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>&mdash;</td>
		{/if}
		{/if}
		{/foreach}
	</tr>
	{/if}
	{assign var='co' value=$operator}
	{/if}
	{foreach from=$o item='d' key='day'}
	<tr class="{cycle values='even,odd'}">
		{if $groupp}<td>{$day}</td>{/if}
        <td nowrap="">{$operators[$operator]}</td>
	{foreach from=$report_dest item='rd' key='dkey'}
	{if $dkey<>'sum'}
	{if isset($d[$dkey])}
		{if $dkey<>900}
			<td>{"`$d[$dkey].clean/60`"|round:2} минут<br />{$d[$dkey].human} часов<br /></td>
		{else}
			<td>{"`$d.sum.clean/60`"|round:2} минут<br />{$d.sum.human} часов<br /></td>
            <td>{"`$d[$dkey].clean/60`"|round:2} минут<br />{$d[$dkey].human} часов<br /></td>
		{/if}
	{elseif $dkey==900}
		<td>{"`$d.sum.clean/60`"|round:2} минут<br />{$d.sum.human} часов<br /></td><td>&mdash;</td>
	{else}
		<td>&mdash;</td>
	{/if}
	{/if}
	{/foreach}
	</tr>
	{/foreach}
	{/foreach}
	{if $groupp && count($report)>1}
	<tr>
        <td colspan="2" class="header" style="background-color: {$bg}; color: {$fg};">Итого по оператору {$operators[$co]}:</td>
		{foreach from=$report_dest item='rd' key='dkey'}
		{if $dkey<>'sum'}
		{if isset($report_oper[$co][$dkey])}
			{if $dkey<>900}
				<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co][$dkey].clean/60`"|round:2} минут<br />{$report_oper[$co][$dkey].human} часов<br />стоимость: {$report_oper[$co][$dkey].price}</td>
			{else}
				<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co].sum.clean/60`"|round:2} минут<br />{$report_oper[$co].sum.human} часов<br />стоимость: {$report_oper[$co].sum.price}</td>
        <td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co][$dkey].clean/60`"|round:2} минут<br />{$report_oper[$co][$dkey].human} часов<br />стоимость: {$report_oper[$co][$dkey].price}</td>
			{/if}
		{elseif $dkey==900}
			<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_oper[$co].sum.clean/60`"|round:2} минут<br />{$report_oper[$co].sum.human} часов<br />стоимость: {$report_oper[$co].sum.price}</td><td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>&mdash;</td>
		{else}
			<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>&mdash;</td>
		{/if}
		{/if}
		{/foreach}
	</tr>
	{/if}
	<tr>
		<td class="header" style="background-color: {$bg}; color: {$fg};" colspan="{if $groupp}2{else}1{/if}" vAlign='bottom'>Итого по всем операторам:</td>
		{foreach from=$report_dest item='rd' key='dkey'}
		{if $dkey<>'sum'}
		{if $dkey<>900}
			<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$rd.clean/60`"|round:2} минут<br />{$rd.human} часов<br />стоимость: {$rd.price|round:2}</td>
		{else}
			<td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$report_dest.sum.clean/60`"|round:2} минут<br />{$report_dest.sum.human} часов<br />стоимость: {$report_dest.sum.price|round:2}</td>
      <td class='header' style="background-color: {$bg}; color: {$fg};" vAlign='bottom'>{"`$rd.clean/60`"|round:2} минут<br />{$rd.human} часов<br />стоимость: {$rd.price|round:2}</td>
		{/if}
		{/if}
		{/foreach}
	</tr>
</table>

{/if}