// Generated by CoffeeScript 1.12.2
(function () {
    var SocketWebClient,
        bind = function (fn, me) {
            return function () {
                return fn.apply(me, arguments);
            };
        };

    SocketWebClient = (function () {
        SocketWebClient.prototype.NOTIFICATION_PERMISSION_GRANTED = 'granted';

        SocketWebClient.prototype.NOTIFICATION_PERMISSION_DENIED = 'denied';

        SocketWebClient.prototype.NOTIFICATION_PERMISSION_DEFAULT = 'default';

        function SocketWebClient() {
            this.socketOnMessage = bind(this.socketOnMessage, this);
            this.socketOnDisconnect = bind(this.socketOnDisconnect, this);
            this.socketOnConnect = bind(this.socketOnConnect, this);
            this.connect = bind(this.connect, this);
            this.renderIcon = bind(this.renderIcon, this);
            if (!window.io || !window.ioUrl) {
                return;
            }
            this.notificationPermission = Notification ? Notification.permission.toLowerCase() : this.NOTIFICATION_PERMISSION_DENIED;
            if (this.notificationPermission === this.NOTIFICATION_PERMISSION_DEFAULT) {
                Notification.requestPermission();
            }
            this.renderIcon();
            this.connect();
        }

        SocketWebClient.prototype.stripTags = function (html) {
            var text, tmp;
            tmp = document.createElement("div");
            tmp.innerHTML = html;
            text = tmp.textContent || tmp.innerText || "";
            return text.replace(/\n/g, '<br/>');
        };

        SocketWebClient.prototype.renderIcon = function () {
            this.socketDiv = $('<div>').addClass('popover fade left in').attr('role', 'tooltip').attr('id', 'socket-div').append($('<div>').addClass('arrow')).hide().appendTo($('body'));
            this.socketImg = $('<span>').addClass('glyphicon glyphicon-eye-close').attr('aria-hidden', 'true').attr('id', 'socket-img').attr('title', 'Серверные уведомления');
            this.socketImg.on('click', (function (_this) {
                return function () {
                    return _this.socketDiv.slideToggle();
                };
            })(this));
            return this.socketImg.appendTo($('#btn-options').parent());
        };

        SocketWebClient.prototype.connect = function () {
            this.socket = io(window.ioUrl);
            this.socketOnConnect();
            this.socketOnDisconnect();
            return this.socketOnMessage();
        };

        SocketWebClient.prototype.socketOnConnect = function () {
            return this.socket.on('connect', (function (_this) {
                return function () {
                    return _this.socketImg.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');
                };
            })(this));
        };

        SocketWebClient.prototype.socketOnDisconnect = function () {
            return this.socket.on('disconnect', (function (_this) {
                return function () {
                    return _this.socketImg.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');
                };
            })(this));
        };

        SocketWebClient.prototype.socketOnMessage = function () {
            return this.socket.on('message', (function (_this) {
                return function (json) {
                    var $newContent, date, dateHours, dateMinutes, message, messageHtml, messageTxt, notification, title, titleHtml, titleTxt;
                    titleHtml = json['title'];
                    titleTxt = _this.stripTags(titleHtml);
                    title = titleTxt;
                    title = $('<span>').append(title + ' ');
                    messageHtml = json['message'];
                    messageTxt = _this.stripTags(messageHtml);
                    message = messageTxt;
                    if (json['url']) {
                        message = $('<a>').attr('href', json['url']).append(message);
                    }
                    message = $('<span>').append(message);
                    message.prepend($('<b>').append(title)).prepend($('<span>').append(json['userFrom'] + ': '));
                    date = new Date();
                    dateHours = date.getHours();
                    if (dateHours < 10) {
                        dateHours = '0' + dateHours;
                    }
                    dateMinutes = date.getMinutes();
                    if (dateMinutes < 10) {
                        dateMinutes = '0' + dateMinutes;
                    }
                    message.prepend('[' + dateHours + ':' + dateMinutes + '] ');
                    $newContent = $('<div>').addClass('alert alert-' + (json['type'] ? json['type'] : 'warning') + ' alert-dismissible fade in').attr('role', 'alert').append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>').append(message);
                    if (json['timeout']) {
                        setTimeout(function () {
                            return $newContent.find('button').click();
                        }, json['timeout']);
                    }
                    _this.socketDiv.append($newContent).show();
                    if (_this.notificationPermission === _this.NOTIFICATION_PERMISSION_DEFAULT) {
                        _this.notificationPermission = Notification ? Notification.permission.toLowerCase() : _this.NOTIFICATION_PERMISSION_DENIED;
                    }
                    if (_this.notificationPermission === _this.NOTIFICATION_PERMISSION_GRANTED) {
                        notification = new Notification(titleTxt, {
                            body: messageTxt,
                            icon: '/images/logo2.gif'
                        });
                        if (json['url']) {
                            return notification.onclick = function () {
                                return window.open(json['url']);
                            };
                        }
                    }
                };
            })(this));
        };

        return SocketWebClient;

    })();

    new SocketWebClient();

}).call(this);
