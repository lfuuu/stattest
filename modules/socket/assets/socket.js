// Generated by CoffeeScript 2.1.0
(function() {
  var SocketWebClient;

  SocketWebClient = (function() {
    class SocketWebClient {
      
      // конструктор
      constructor() {
        
        // отрендерить иконку
        this.renderIcon = this.renderIcon.bind(this);
        // соединиться с сокет-сервером
        this.connect = this.connect.bind(this);
        //    @socket.emit('message', {message: 'Hello, world!'})

        // при установке соединения
        this.socketOnConnect = this.socketOnConnect.bind(this);
        // при разрыве соединения
        this.socketOnDisconnect = this.socketOnDisconnect.bind(this);
        // при получении события
        this.socketOnMessage = this.socketOnMessage.bind(this);
        if (!window.io || !window.ioUrl) {
          return;
        }
        // разрешены ли нотификации
        // сокет-сервер упал
        this.notificationPermission = Notification ? Notification.permission.toLowerCase() : this.NOTIFICATION_PERMISSION_DENIED;
        if (this.notificationPermission === this.NOTIFICATION_PERMISSION_DEFAULT) {
          // "по запросу" - запросить разрешение на уведомление
          Notification.requestPermission(); // https://habrahabr.ru/post/183630/
        }
        
        // @link https://notifyjs.com/
        // Но ссылки нельзя указывать :-(
        // $.notify('Комментарий добавлен', {className: 'success', autoHideDelay: 3000});

        // отрендерить иконку
        this.renderIcon();
        // соединиться с сокет-сервером
        this.connect();
      }

      // удалить теги
      stripTags(html) {
        var text, tmp;
        tmp = document.createElement("div");
        tmp.innerHTML = html;
        text = tmp.textContent || tmp.innerText || "";
        return text.replace(/\n/g, '<br/>'); // nl2br
      }

      renderIcon() {
        this.socketDiv = $('<div>').addClass('popover fade left in').attr('role', 'tooltip').attr('id', 'socket-div').append($('<div>').addClass('arrow')).hide().appendTo($('body'));
        this.socketImg = $('<span>').addClass('glyphicon glyphicon-eye-close').attr('aria-hidden', 'true').attr('id', 'socket-img').attr('title', 'Серверные уведомления');
        this.socketImg.on('click', () => {
          return this.socketDiv.slideToggle();
        });
        return this.socketImg.appendTo($('#btn-options').parent());
      }

      connect() {
        this.socket = io(window.ioUrl);
        this.socketOnConnect();
        this.socketOnDisconnect();
        return this.socketOnMessage();
      }

      socketOnConnect() {
        return this.socket.on('connect', () => {
          return this.socketImg.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');
        });
      }

      socketOnDisconnect() {
        return this.socket.on('disconnect', () => {
          return this.socketImg.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');
        });
      }

      socketOnMessage() {
        return this.socket.on('message', (json) => {
          var $newContent, date, dateHours, dateMinutes, message, notification, title;
          title = $('<span>').append(json['title']);
          message = $('<div>').append(json['messageHtml']);
          // добавить отправителя
          message.prepend($('<b>').append(title)).prepend($('<span>').append(json['userFrom'] + ': '));
          // добавить дату
          date = new Date();
          dateHours = date.getHours();
          if (dateHours < 10) {
            dateHours = '0' + dateHours;
          }
          dateMinutes = date.getMinutes();
          if (dateMinutes < 10) {
            dateMinutes = '0' + dateMinutes;
          }
          message.prepend('[' + dateHours + ':' + dateMinutes + '] ');
          // добавить во всплывашку
          $newContent = $('<div>').addClass('alert alert-' + (json['type'] ? json['type'] : 'warning') + ' alert-dismissible fade in').attr('role', 'alert').append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>').append(message);
          // автоскрыть всплывашку
          if (json['timeout']) {
            setTimeout(function() {
              return $newContent.find('button').click();
            }, json['timeout']);
          }
          this.socketDiv.append($newContent).show();
          // кроме уведомления во вкладку браузера попытаемся сделать системное уведомление
          if (this.notificationPermission === this.NOTIFICATION_PERMISSION_DEFAULT) {
            // "по запросу" - обновить статус, ибо юзер уже мог разрешить или запретить
            this.notificationPermission = Notification ? Notification.permission.toLowerCase() : this.NOTIFICATION_PERMISSION_DENIED;
          }
          if (this.notificationPermission === this.NOTIFICATION_PERMISSION_GRANTED && json['messageTxt'] && json['isNotification'] === 1) {
            // "разрешено" - отправить уведомление
            console.log(json);
            notification = new Notification(json['title'], {
              //tag : '',
              body: json['messageTxt'],
              icon: '/images/logo2.gif'
            });
            // Обработчик клика
            if (json['url']) {
              return notification.onclick = function() {
                return window.open(json['url']);
              };
            }
          }
        });
      }

    };

    // разрешены ли нотификации
    SocketWebClient.prototype.NOTIFICATION_PERMISSION_GRANTED = 'granted'; // да

    SocketWebClient.prototype.NOTIFICATION_PERMISSION_DENIED = 'denied'; // нет

    SocketWebClient.prototype.NOTIFICATION_PERMISSION_DEFAULT = 'default'; // по запросу

    return SocketWebClient;

  })();

  new SocketWebClient();

}).call(this);
