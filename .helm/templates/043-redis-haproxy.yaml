{{ $_ := set . "postfix_name" (printf "%s-%s" .Chart.Name (env "ENVNAME" | lower)) }}
{{ $_ := set . "redis_server" .Values.redis_server_dev }}

{{- if (eq (env "ENVNAME") "prod") }}
  {{ $_ := set . "redis_server" .Values.redis_server_prod }}
{{ end }}

{{ if and (eq (int .redis_server.is_standalone) 0) (eq (env "COUNTRY") "EU") }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
data:
  haproxy.cfg: |
    global
    	daemon
    	maxconn 1024
    
    defaults
    	mode tcp
    	timeout connect 5000ms
    	timeout client 50000ms
    	timeout server 50000ms
    
    
    frontend http
    	bind :8080
    	default_backend stats
    
    
    backend stats
    	mode http
    	stats enable
    
    	stats enable
    	stats uri /
    	stats refresh 1s
    	stats show-legends
    	stats admin if TRUE
    
    resolvers k8s
      parse-resolv-conf
      hold other           10s
      hold refused         10s
      hold nx              10s
      hold timeout         10s
      hold valid           10s
      hold obsolete        10s
    
    frontend redis-write
        bind *:6379
    	default_backend redis-primary
    
    backend redis-primary
    	mode tcp
    	balance first
    	option tcp-check
    	tcp-check send info\ replication\r\n
    	tcp-check expect string role:master
        server-template redis-server- 0-2 redis-db.{{ .postfix_name }}.svc.cluster.local:6379 check inter 3s resolvers k8s init-addr none

  tmp.conf: | 
    #empty
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-haproxy
  labels:
    app: redis-haproxy
spec:
  replicas: {{ .redis_server.haproxies }}
  selector:
    matchLabels:
      app: redis-haproxy
  template:
    metadata:
      name: haproxy-pod
      labels:
        app: redis-haproxy
      annotations:
        scheduler.alpha.kubernetes.io/affinity: >
          {
            "podAntiAffinity": {
              "preferredDuringSchedulingIgnoredDuringExecution": [{
                "labelSelector": {
                  "matchExpressions": [{
                    "key": "app",
                    "operator": "In",
                    "values": ["redis-haproxy"]
                  }]
                },
                "topologyKey": "kubernetes.io/hostname"
              }]
            }
          }
    spec:
    #   affinity:
    #     podAntiAffinity:
    #       requiredDuringSchedulingIgnoredDuringExecution:
    #         - labelSelector:
    #             matchExpressions:
    #             - key: app
    #               operator: In
    #               values:
    #                 - haproxy
    #           topologyKey: "kubernetes.io/hostname"
      containers:
        - name: haproxy
          image: haproxy:2.3
          ports:
            - containerPort: 8080
            - containerPort: 6379
          volumeMounts:
          - name: config
            mountPath: /usr/local/etc/haproxy/haproxy.cfg
            subPath: haproxy.cfg
            readOnly: true
      restartPolicy: Always
      volumes:
      - name: config
        configMap:
          name: haproxy-config
---
apiVersion: /v1
kind: Service
metadata:
  name: {{ .Values.redis_prod.host }}
spec:
  type: LoadBalancer
  ports:
    - name: dashboard
      port: 8080
      targetPort: 8080
    - name: redis-write
      port: 6379
      targetPort: 6379
  selector:
    app: redis-haproxy
{{ end }}