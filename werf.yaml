{{ $_ := set . "project" "stat" }}
{{ $_ := env "CI_DIR_HOME" | set . "ci_dir_home" }}


project: {{ .project }}
configVersion: 1

################################## PRODUCTION ###########################################################
{{ $_ := env "ENVNAME" | set . "env" }}
# for lint
#{{ $_ := set . "env" "prod" }}

{{- if or (eq .env "prod") (eq .env "stage") }}

---
image: {{ .project }}-nginx-prod
from: nginx:1.15.3-alpine
docker:
  WORKDIR: {{ .ci_dir_home }}/stat
  USER: root
  EXPOSE: "80 8080 81 8081"

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "*"

ansible:
  beforeInstall:
    - name: "Nginx 1"
      shell: |
        apk add wget vim
        apk add telnet
        apk add unzip net-tools mc
        apk add nano
        apk add curl
        apk update
  install:
    - name: "Nginx 2"
      shell: |
        cd {{ .ci_dir_home }}/stat
        chmod -R 777 runtime
        chmod 777 web/assets
        mkdir stat/design_c
        chmod 777 stat/design_c
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
    - name: "Nginx 3"
      shell: |
        cd {{ .ci_dir_home }}/stat
        cp stat/local.conf.php.tpl stat/local.conf.php
      args:
        chdir: {{ .ci_dir_home }}/stat
---
image: {{ .project }}-php-fpm-prod
from: php:7.4.11-fpm-alpine3.12
docker:
  WORKDIR: {{ .ci_dir_home }}/stat
  USER: root
  ENV:
    MYSQL_DB: nispd
    MYSQL_HOST: mysql
    MYSQL_USER: stat
    MYSQL_PASSWORD: stat
    POSTGRES_DB: nispd
    POSTGRES_HOST: postgres
    POSTGRES_HOST_SLAVE: postgres
    POSTGRES_USER: stat
    POSTGRES_PASSWORD: stat
    REDIS_HOST: redis
    API_SECURE_KEY: 123
  EXPOSE: "9000"
  #ENTRYPOINT: ["{{ .ci_dir_home }}/stat/ENTRYPOINT.sh"]
  #CMD: ["/bin/sh","{{ .ci_dir_home }}/stat/ENTRYPOINT.sh"]

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: "Php-fpm: 1. Utils"
      shell: |
        apk update && apk upgrade
        apk add wget
        apk add unzip
        apk add net-tools mc
        apk add nano
        apk add curl
        apk add cronie
        apk add mysql
        apk add git
        # libs
        apk add \
            libzip-dev \
            libc-client-dev \
            libkrb5-dev \
            libpng-dev \
            libjpeg-dev \
            libwebp-dev \
            libfreetype6-dev \
            libkrb5-dev \
            libicu-dev \
            zlib1g-dev \
            zstd-dev \
            zip \
            bzip2-dev \
            ffmpeg \
            libmemcached11 \
            libmemcachedutil2 \
            build-essential \
            libmemcached-dev \
            gnupg2 \
            libpq-dev \
            libpq5 \
            libz-dev \
            libxml2-dev \
            libxslt-dev \
            procps \
            telnet \
            iputils-ping \
            vim \
            htop
        # dirs
        mkdir /run/php-fpm/
        touch /run/php-fpm/php-fpm.pid
        mkdir -p /var/lib/php/session
        chmod 777 /var/lib/php/session
  install:
    - name: "Php-fpm: 2. Configs"
      shell: |
        apk add libssh2-dev
        cd /tmp/
        curl https://raw.githubusercontent.com/mlocati/docker-php-extension-installer/master/install-php-extensions >> install-php-extensions
        mv install-php-extensions /usr/local/bin/
        chmod uga+x /usr/local/bin/install-php-extensions && sync
        # install extensions 1
        install-php-extensions bcmath bz2 calendar exif gd gettext intl mysqli
        # install extensions 2
        install-php-extensions pcntl pdo_mysql pdo_pgsql pgsql soap shmop sockets sysvmsg sysvsem sysvshm xmlrpc xsl
        # install extensions 3
        install-php-extensions apcu gmp memcache snmp zip
        # install pecl extensions
        install-php-extensions amqp igbinary mcrypt msgpack redis ssh2
        # install xdebug extension
        # install-php-extensions xdebug
        # permissions
        cd {{ .ci_dir_home }}/stat
        chmod -R 777 runtime
        chmod 777 web/assets
        mkdir stat/design_c
        chmod 777 stat/design_c
        # configs
        cp stat/local.conf.php.tpl stat/local.conf.php
        chmod a+x *.sh
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
    - name: "Php-fpm: 3. Install dependencies"
      shell: |
        # install composer
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer
        composer self-update --1
        composer global require "fxp/composer-asset-plugin"
        # vendors
        composer install
        composer clear-cache
      args:
        chdir: {{ .ci_dir_home }}/stat

---
image: {{ .project }}-node-comet-prod
from: node:9.11.2
docker:
  WORKDIR: {{ .ci_dir_home }}/stat/comet-server
  USER: root
  EXPOSE: "3000"
  ENV:
    LC_ALL: en_US.UTF-8
    TERM: xterm
    COLORTERM: truecolor
  #CMD: ["/bin/sleep","infinity"]
  CMD: ["node","{{ .ci_dir_home }}/stat/comet-server/index.js"]

git:
  - url: git@github.com:welltime/comet-server.git
    branch: master
    herebyIAdmitThatBranchMightBreakReproducibility: true
    add: /
    to: {{ .ci_dir_home }}/stat/comet-server
    stageDependencies:
      setup:
        - "**/package.*"

ansible:
  beforeInstall:
    - name: "Comet-server: 1. Utils"
      shell: |
        apt-get update
        apt-get install -y \
                    tmux \
                    unzip \
                    net-tools \
                    mc \
                    zip \
                    procps \
                    telnet \
                    iputils-ping \
                    wget \
                    vim \
                    nano \
                    curl \
                    htop
  install:
    - name: "Comet-server: 2. Configs"
      shell: |
        cd {{ .ci_dir_home }}/stat/comet-server
        sed -i "s/\"socket.io\": \"\*\"/\"socket.io\": \"^2.3.0\"/" package.json
        # configs
        cd {{ .ci_dir_home }}/stat
        # cp config.json comet-server/config.json
        cd {{ .ci_dir_home }}/stat/comet-server
        chmod a+x *.sh
      args:
        chdir: {{ .ci_dir_home }}/stat/comet-server
  setup:
    - name: "Comet-server: 3. Install packages"
      shell: |
        npm -g install coffee-script -y
        npm i
      args:
        chdir: {{ .ci_dir_home }}/stat/comet-server
---
image: {{ .project }}-redis-prod
from: quay.io/continuouspipe/redis3:latest

ansible:
  beforeInstall:
    - name: 1
      shell: |
        apt-get update
        apt-get install -y --no-install-recommends htop iputils-ping net-tools

docker:
  #CMD: ["redis-server"]
  CMD: ["/bin/sleep","infinity"]
  EXPOSE: "6379"

################################## DEV ENVIRONMENT ###########################################################
{{- else if (eq .env "dev") }}

---
image: {{ .project }}-pgdb-dev
from: postgres:12.3
#git:
#  - add: /install/db/SQL/init.sql
#    to: /docker-entrypoint-initdb.d/init.sql
---
image: {{ .project }}-dev
from: centos/systemd

docker:
  WORKDIR: /root
  USER: root
  ENV:
    MYSQL_DB: nispd
    MYSQL_HOST: mysql
    MYSQL_USER: stat
    MYSQL_PASSWORD: stat
    POSTGRES_DB: nispd
    POSTGRES_HOST: postgres
    POSTGRES_USER: stat
    POSTGRES_PASSWORD: stat
  # LC_ALL: en_US.UTF-8
  CMD: ["/usr/sbin/init"]
  EXPOSE: "80 8080"

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: 1
      shell: |
        yum install -y epel-release
        yum install -y wget vim
        yum install -y telnet
        yum install -y unzip net-tools mc
        yum install -y nano
        yum -y install curl
        yum -y update
        yum install -y nginx cronie
        yum -y update && yum -y upgrade
        yum install -y mysql
        yum install -y http://rpms.remirepo.net/enterprise/remi-release-7.rpm
        yum -y update && yum -y upgrade
        yum-config-manager --enable remi-php74
        yum install -y php php-fpm php-cli php-curl php-gd php-json php-mcrypt php-mysqlnd php-pgsql php-readline php-xmlrpc php-intl php-mbstring php-bcmath php-xmlwriter php-process php-pecl-redis php-pecl-amqp php-pecl-xdebug php-pecl-ssh2 php-soap
        yum clean all
        mkdir /run/php-fpm/
        touch /run/php-fpm/php-fpm.pid
        mkdir -p /var/lib/php/session
        chmod 777 /var/lib/php/session
  install:
    - name: 2
      shell: |
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer
        composer self-update --1
        composer global require "fxp/composer-asset-plugin"
        cd {{ .ci_dir_home }}/stat
        cp stat/local.conf.php.tpl stat/local.conf.php
        chmod -R 777 runtime
        chmod 777 web/assets
        mkdir stat/design_c
        chmod 777 stat/design_c
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
    - name: 3
      shell: |
        composer install
        composer clear-cache
      args:
        chdir: {{ .ci_dir_home }}/stat

{{ end }}
