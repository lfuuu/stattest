{{ $_ := set . "project" "stat" }}
{{ $_ := env "CI_DIR_HOME" | set . "ci_dir_home" }}


project: {{ .project }}
configVersion: 1

################################## PRODUCTION ###########################################################
{{ $_ := env "ENVNAME" | set . "env" }}
## for lint
# {{ .env }}
# {*{ $_ := set . "env" "prod" }*}

{{- if or (eq .env "prod") (eq .env "dev") (eq .env "stage2") }}

---
image: {{ .project }}-nginx-{{ .env }}
from: nginx:stable-alpine
docker:
  WORKDIR: {{ .ci_dir_home }}/stat
  USER: root
  EXPOSE: "80 8080 81 8081"

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "*"

ansible:
  beforeInstall:
    - name: "Nginx 1"
      shell: |
        apk add wget vim
        apk add telnet
        apk add unzip net-tools mc
        apk add nano
        apk add curl vim
        apk update
        # nginx:nginx -> 509:509
        # as jenkins:jenkins on tiberis
        apk --no-cache add shadow
        groupmod -g 509 nginx
        usermod -u 509 -g 509 nginx
        # id nginx
  install:
    - name: "Nginx 2"
      shell: |
        cd {{ .ci_dir_home }}/stat
        mkdir stat/design_c
        chown -R nginx:nginx {{ .ci_dir_home }}/stat
        #export dir
        ln -Tfs {{ .ci_dir_home }}/store/web/export {{ .ci_dir_home }}/stat/web/export
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
    - name: "Nginx 3"
      shell: |
        cd {{ .ci_dir_home }}/stat
        #cp stat/local.conf.php.tpl stat/local.conf.php
      args:
        chdir: {{ .ci_dir_home }}/stat
---
image: {{ .project }}-php-fpm-{{ .env }}
from: php:7.4-fpm-alpine3.12
docker:
  WORKDIR: {{ .ci_dir_home }}/stat
  USER: root
  ENV:
    MYSQL_DB: nispd
    MYSQL_HOST: mysql
    MYSQL_USER: stat
    MYSQL_PASSWORD: stat
    POSTGRES_DB: nispd
    POSTGRES_HOST: postgres
    POSTGRES_SLAVE_HOST: postgres
    POSTGRES_USER: stat
    POSTGRES_PASSWORD: stat
    REDIS_HOST: redis
    API_SECURE_KEY: 123
  EXPOSE: "9000"
  #ENTRYPOINT: ["{{ .ci_dir_home }}/stat/ENTRYPOINT.sh"]
  #CMD: ["/bin/sh","{{ .ci_dir_home }}/stat/ENTRYPOINT.sh"]

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: "Php-fpm: 1. Utils"
      shell: |
        echo "http://dl-3.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-3.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        echo "http://dl-4.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-4.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        echo "http://dl-5.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-5.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        apk update && apk upgrade
        apk add wget
        apk add unzip
        apk add net-tools mc
        apk add curl
        apk add cronie
        apk add 
        apk add git
        apk add vim
        # libs
        apk add \
            libzip-dev \
            libc-client-dev \
            libkrb5-dev \
            libpng-dev \
            libjpeg-dev \
            libwebp-dev \
            libfreetype6-dev \
            libkrb5-dev \
            libicu-dev \
            zlib1g-dev \
            zstd-dev \
            zip \
            bzip2-dev \
            ffmpeg \
            libmemcached11 \
            libmemcachedutil2 \
            build-essential \
            libmemcached-dev \
            gnupg2 \
            libpq-dev \
            libpq5 \
            libz-dev \
            libxml2-dev \
            libxslt-dev \
            procps \
            telnet \
            iputils-ping \
            htop
        apk add busybox-extras
        # www-data:www-data -> 509:509
        # as jenkins:jenkins on tiberis
        # and as nginx:nginx on nginx container in the POD
        apk --no-cache add shadow
        groupmod -g 509 www-data
        usermod -u 509 -g 509 www-data
        # id www-data
        # dirs
        mkdir /run/php-fpm/
        touch /run/php-fpm/php-fpm.pid
        chown -R www-data:www-data /run/php-fpm/
        mkdir -p /var/lib/php/session
        chown -R www-data:www-data /var/lib/php/session
        # ssh for cryptopro
        mkdir /root/.ssh/
        mkdir /home/www-data/.ssh/
        apk add openssh-client
  install:
    - name: "Php-fpm: 2. Configs"
      shell: |
        apk add libssh2-dev
        cd /tmp/
        # curl https://raw.githubusercontent.com/mlocati/docker-php-extension-installer/master/install-php-extensions >> install-php-extensions
        curl -L https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions >> install-php-extensions
        mv install-php-extensions /usr/local/bin/
        chmod uga+x /usr/local/bin/install-php-extensions && sync
        # install extensions 1
        install-php-extensions rdkafka
        install-php-extensions bcmath
        install-php-extensions bz2 calendar exif gd gettext 
        install-php-extensions intl mysqli  
        # install extensions 2
        install-php-extensions pcntl pdo_mysql pdo_pgsql pgsql soap shmop sockets sysvmsg sysvsem sysvshm xmlrpc xsl
        # install extensions 3
        install-php-extensions apcu gmp memcache zip
        # install pecl extensions
        install-php-extensions igbinary mcrypt msgpack redis
        install-php-extensions ssh2
        install-php-extensions amqp
        # install xdebug extension
        # install-php-extensions xdebug
        # permissions
        cd {{ .ci_dir_home }}/stat
        mkdir stat/design_c
        chown -R www-data:www-data {{ .ci_dir_home }}/stat
        # configs
        #cp stat/local.conf.php.tpl stat/local.conf.php
        chmod a+x *.sh
        #export dir
        ln -Tfs {{ .ci_dir_home }}/store/web/export {{ .ci_dir_home }}/stat/web/export
        #add wkhtmltopdf
        apk add qt5-qtbase-dev wkhtmltopdf imagemagick zbar
        ln -s /usr/bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf
        # fonts
        apk add --update \
            xvfb \
            fontconfig \
            dbus \
            exiftool \
            tzdata \
            ca-certificates
        apk add --update \
            libgcc libstdc++ libx11 glib libxrender libxext libintl \
            libcrypto1.0 libssl1.0 \
            ttf-dejavu ttf-droid ttf-freefont ttf-liberation ttf-ubuntu-font-family
        apk add libwmf
        fc-cache -f
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
    - name: "Php-fpm: 3. Install dependencies"
      shell: |
        # install composer
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer
        composer self-update --1
        composer global require "fxp/composer-asset-plugin"
        # vendors
        composer install --prefer-dist
        composer clear-cache
        # rights
        chown -R www-data:www-data {{ .ci_dir_home }}/stat/vendor
        chown www-data:www-data {{ .ci_dir_home }}/stat/composer*
        
        ### Yii 2.0.37: Bug #18171: Change case of column names in SQL query for findConstraints to fix MySQL 8 compatibility
        ### Need update Yii2
        sed -r -i 's/^\s+kcu\.([^ ,]+)(,|$)/kcu.\1 as \1\2/'  vendor/yiisoft/yii2/db/mysql/Schema.php
        
        ### fix PHPExcel (PHPExcel - does not develop)
        sed -i 's/\$pValue{0}/((string)\$pValue)[0]/' vendor/phpoffice/phpexcel/Classes/PHPExcel/Cell/DefaultValueBinder.php

      args:
        chdir: {{ .ci_dir_home }}/stat

{{ if eq (env "IS_WITH_CRON") "1" }}
---
image: {{ .project }}-cron-{{ .env }}
from: php:7.4-alpine3.12
docker:
  WORKDIR: {{ .ci_dir_home }}/stat
  USER: root
  ENV:
    MYSQL_DB: nispd
    MYSQL_HOST: mysql
    MYSQL_USER: stat
    MYSQL_PASSWORD: stat
    POSTGRES_DB: nispd
    POSTGRES_HOST: postgres
    POSTGRES_SLAVE_HOST: postgres
    POSTGRES_USER: stat
    POSTGRES_PASSWORD: stat
    REDIS_HOST: redis
    API_SECURE_KEY: 123
#  EXPOSE: "9000"
  #ENTRYPOINT: ["{{ .ci_dir_home }}/stat/ENTRYPOINT.sh"]
  #CMD: ["/bin/sh","{{ .ci_dir_home }}/stat/ENTRYPOINT.sh"]

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: "Php: 1. Utils"
      shell: |
        echo "http://dl-3.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-3.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        echo "http://dl-4.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-4.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        echo "http://dl-5.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-5.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        apk update && apk upgrade
        apk add wget
        apk add unzip
        apk add net-tools mc
        apk add curl
        apk add cronie
        apk add mysql
        apk add git
        apk add vim
        apk add tmux
        # libs
        apk add \
            libzip-dev \
            libc-client-dev \
            libkrb5-dev \
            libpng-dev \
            libjpeg-dev \
            libwebp-dev \
            libfreetype6-dev \
            libkrb5-dev \
            libicu-dev \
            zlib1g-dev \
            zstd-dev \
            zip \
            bzip2-dev \
            ffmpeg \
            libmemcached11 \
            libmemcachedutil2 \
            build-essential \
            libmemcached-dev \
            gnupg2 \
            libpq-dev \
            libpq5 \
            libz-dev \
            libxml2-dev \
            libxslt-dev \
            procps \
            telnet \
            iputils-ping \
            htop
        apk add busybox-extras
        apk --no-cache add shadow
        # id www-data
        # dirs
        # ssh for cryptopro
        mkdir /root/.ssh/
        apk add openssh-client
  install:
    - name: "Php (cron): 2. Install PHP extension"
      shell: |
        apk add libssh2-dev
        cd /tmp/
        # curl https://raw.githubusercontent.com/mlocati/docker-php-extension-installer/master/install-php-extensions >> install-php-extensions
        curl -L https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions >> install-php-extensions
        mv install-php-extensions /usr/local/bin/
        chmod uga+x /usr/local/bin/install-php-extensions && sync
        # install extensions 1
        install-php-extensions bcmath
        install-php-extensions bz2 calendar exif gd gettext 
        install-php-extensions intl mysqli  
        # install extensions 2
        install-php-extensions pdo_mysql
        install-php-extensions pdo_pgsql
        install-php-extensions pgsql
        install-php-extensions pcntl soap shmop sockets sysvmsg sysvsem sysvshm xmlrpc xsl
        # install extensions 3
        install-php-extensions apcu gmp memcache zip
        # install pecl extensions
        install-php-extensions igbinary mcrypt msgpack redis
        install-php-extensions ssh2
        install-php-extensions amqp
        install-php-extensions rdkafka
        # install xdebug extension
        # install-php-extensions xdebug
        # permissions
        cd {{ .ci_dir_home }}/stat
        mkdir stat/design_c
        chown -R www-data:www-data {{ .ci_dir_home }}/stat
        # configs
        #cp stat/local.conf.php.tpl stat/local.conf.php
        chmod a+x *.sh
        #export dir
        ln -Tfs {{ .ci_dir_home }}/store/web/export {{ .ci_dir_home }}/stat/web/export
        #add wkhtmltopdf
        apk add qt5-qtbase-dev wkhtmltopdf imagemagick zbar
        ln -s /usr/bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf
        # fonts
        apk add --update \
            xvfb \
            fontconfig \
            dbus \
            exiftool \
            tzdata \
            ca-certificates
        apk add --update \
            libgcc libstdc++ libx11 glib libxrender libxext libintl \
            libcrypto1.0 libssl1.0 \
            ttf-dejavu ttf-droid ttf-freefont ttf-liberation ttf-ubuntu-font-family
        apk add libwmf
        fc-cache -f
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
      - name: "Php (cron): 3. Install dependencies"
        shell: |
          # install composer
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer
          composer self-update --1
          composer global require "fxp/composer-asset-plugin"
          # vendors
          composer install --prefer-dist
          composer clear-cache
          # rights
          chown -R www-data:www-data {{ .ci_dir_home }}/stat/vendor
          chown www-data:www-data {{ .ci_dir_home }}/stat/composer*
        args:
          chdir: {{ .ci_dir_home }}/stat
{{ end }}
{{ if eq (env "IS_WITH_COMET") "1" }}
---
image: {{ .project }}-node-comet-{{ .env }}
##from: node:9.11.2
from: node:18.0.0
docker:
  WORKDIR: {{ .ci_dir_home }}/comet-server
  USER: root
  EXPOSE: "3000"
  ENV:
    LC_ALL: en_US.UTF-8
    TERM: xterm
    COLORTERM: truecolor
  #CMD: ["/bin/sleep","infinity"]
  ENTRYPOINT: ["node","{{ .ci_dir_home }}/comet-server/index.js"]

git:
  - url: git@gitlab.mcnloc.ru:stat/comet-server.git
    branch: master
    herebyIAdmitThatBranchMightBreakReproducibility: true
    add: /
    to: {{ .ci_dir_home }}/comet-server
    stageDependencies:
      setup:
        - "**/package.*"

ansible:
  beforeInstall:
    - name: "Comet-server: 1. Utils"
      shell: |
        apt-get update
        apt-get install -y \
                    tmux \
                    unzip \
                    net-tools \
                    mc \
                    zip \
                    procps \
                    telnet \
                    iputils-ping \
                    wget \
                    vim \
                    nano \
                    curl \
                    htop
  install:
    - name: "Comet-server: 2. Configs"
      shell: |
        cd {{ .ci_dir_home }}/comet-server
        # fix package
        sed -i "s/\"socket.io\": \"\*\"/\"socket.io\": \"^2.3.0\"/" package.json
        cd {{ .ci_dir_home }}/comet-server
        chmod a+x *.sh
      args:
        chdir: {{ .ci_dir_home }}/comet-server
  setup:
    - name: "Comet-server: 3. Install packages"
      shell: |
        npm -g install coffee-script -y
        npm i
      args:
        chdir: {{ .ci_dir_home }}/comet-server
{{ end }}
{{ if eq (env "IS_WITH_BALANCE") "1" }}
---
image: {{ .project }}-node-balance3-{{ .env }}
from: node:18.0.0
docker:
  WORKDIR: /workspace/app
  USER: root
  EXPOSE: {{ .Values.node_balance.port | quote}}
  ENV:
    LC_ALL: en_US.UTF-8
    TERM: xterm
    COLORTERM: truecolor
    NODE_PATH: .:/usr/local/lib/node_modules
{{- if eq (env "ENVNAME") "dev" }}
  CMD: ["/bin/sleep","infinity"]
{{- else }}
  CMD: ["node","index.js"]
{{- end }}

{{ if ne (env "ENVNAME") "dev" }}
git:
  - url: git@gitlab.mcnloc.ru:stat/balance_receipt_service.git
    branch: master
    herebyIAdmitThatBranchMightBreakReproducibility: true
    add: /
    to: /workspace/app
{{ end }}

ansible:
  beforeInstall:
    - name: "1. Utils"
      shell: |
        apt-get update
        apt-get install -y \
                     vim \
                     mc
  beforeSetup:
      - name: "2. Install packages"
        shell: |
          npm instal -g -y websocket kafkajs


{{ end }}
---
image: {{ .project }}-redis-{{ .env }}
#from: quay.io/continuouspipe/redis3:latest
from: redis:7.0.11

ansible:
  beforeInstall:
    - name: 1
      shell: |
        apt-get update
        apt-get install -y --no-install-recommends htop iputils-ping net-tools

docker:
  #CMD: ["redis-server"]
  CMD: ["/bin/sleep","infinity"]
  EXPOSE: "6379"

### graphql, cryptopro, nnp-ported only in prod (can be enabled if necessary.)
{{ if eq (env "IS_WITH_NNPPORTED") "1" }}
---
image: {{ .project }}-node-nnp-ported-{{ .env }}
#from: node:9.11.2
from: node:18.0.0
docker:
  WORKDIR: {{ .ci_dir_home }}/nnp-ported
  USER: root
  EXPOSE: "3001"
  ENV:
    LC_ALL: en_US.UTF-8
    TERM: xterm
    COLORTERM: truecolor
  #CMD: ["/bin/sleep","infinity"]
  CMD: ["node","{{ .ci_dir_home }}/nnp-ported/index.js"]

git:
  - url: git@gitlab.mcnloc.ru:stat/nnp-ported.git
    branch: master
    herebyIAdmitThatBranchMightBreakReproducibility: true
    add: /
    to: {{ .ci_dir_home }}/nnp-ported
    stageDependencies:
      setup:
        - "**/package.*"

ansible:
  beforeInstall:
    - name: "NNP-ported: 1. Utils"
      shell: |
        apt-get update
        apt-get install -y \
                    tmux \
                    unzip \
                    net-tools \
                    mc \
                    zip \
                    procps \
                    telnet \
                    iputils-ping \
                    wget \
                    vim \
                    nano \
                    curl \
                    htop
  install:
    - name: "NNP-ported: 2. Configs"
      shell: |
        cd {{ .ci_dir_home }}/nnp-ported
        chmod a+x *.sh
      args:
        chdir: {{ .ci_dir_home }}/nnp-ported
  setup:
    - name: "NNP-ported: 3. Install packages"
      shell: |
        npm -g install coffee-script -y
        npm i
      args:
        chdir: {{ .ci_dir_home }}/nnp-ported
{{ end }}
{{ if eq (env "IS_WITH_GRAPHQL") "1" }}
---
image: {{ .project }}-graphql-{{ .env }}
from: hasura/graphql-engine:latest

ansible:
  beforeInstall:
    - name: 1
      shell: |
        pwd

docker:
  #CMD: ["graphql-engine" "serve"]
  CMD: ["/bin/sleep","infinity"]
  EXPOSE: "8080"
{{ end }}
{{ if eq (env "IS_WITH_CRYPTOPRO") "1" }}
---
image: {{ .project }}-cryptopro-{{ .env }}
from: centos:7

ansible:
  beforeInstall:
    - name: 1
      shell: |
        yum install -y wget nano
        ENV container docker
        cd /lib/systemd/system/sysinit.target.wants
        for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done
        rm -f /lib/systemd/system/multi-user.target.wants/*
        rm -f /etc/systemd/system/*.wants/*
        rm -f /lib/systemd/system/local-fs.target.wants/*
        rm -f /lib/systemd/system/sockets.target.wants/*udev*
        rm -f /lib/systemd/system/sockets.target.wants/*initctl*
        rm -f /lib/systemd/system/basic.target.wants/*
        rm -f /lib/systemd/system/anaconda.target.wants/*
        yum install lsb-core-noarch openssh-server openssh -y
        # Установка Cryptopro
        cd /root
        wget http://ngtbackup.mcn.ru/cprocsp-pki-2.0.0-amd64-cades.rpm
        wget http://ngtbackup.mcn.ru/linux-amd64_deb.tgz
        tar xf linux-amd64_deb.tgz
        cd /root/linux-amd64
        ./install.sh

docker:
  USER: root
  WORKDIR: /root
  CMD: ["/root/start.sh"]
  #CMD: ["/bin/sleep","infinity"]
  EXPOSE: "22"
{{ end }}

{{ if eq (env "IS_WITH_MAILER") "1" }}
---
image: {{ .project }}-mailer-php-fpm-{{ .env }}
from: php:7.4-fpm-alpine3.16
docker:
  WORKDIR: /app/mailer
  USER: root
  EXPOSE: "9000"
  CMD: ["/bin/sleep","infinity"]

git:
  - url: git@gitlab.mcnloc.ru:stat/mailer.git
    branch: master
    herebyIAdmitThatBranchMightBreakReproducibility: true
    add: /
    to: /app/mailer
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: "Php-fpm: 1. Utils"
      shell: |
        echo "http://dl-3.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-3.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        echo "http://dl-4.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-4.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        echo "http://dl-5.alpinelinux.org/alpine/v3.10/main/" >> /etc/apk/repositories
        echo "http://dl-5.alpinelinux.org/alpine/v3.10/community/" >> /etc/apk/repositories
        apk update && apk upgrade
        apk add busybox-extras
        apk add net-tools mc vim util-linux less
        groupmod -g 509 www-data
        usermod -u 509 -g 509 www-data
        # id www-data
        # dirs
        mkdir /run/php-fpm/
        touch /run/php-fpm/php-fpm.pid
        chown -R www-data:www-data /run/php-fpm/
        mkdir -p /var/lib/php/session
        chown -R www-data:www-data /var/lib/php/session
  install:
    - name: "Php-fpm: 2. Configs"
      shell: |
        cd /tmp/
        curl https://raw.githubusercontent.com/mlocati/docker-php-extension-installer/master/install-php-extensions >> install-php-extensions
        mv install-php-extensions /usr/local/bin/
        chmod uga+x /usr/local/bin/install-php-extensions && sync
        install extensions 1
        install-php-extensions gettext intl mysqli pdo_mysql
        chown -R www-data:www-data /app/mailer
      args:
        chdir: /app/mailer
  setup:
      - name: "Php-fpm: 3. Install dependencies"
        shell: |
          # install composer
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer
          composer self-update --1
          composer global require "fxp/composer-asset-plugin"
          # vendors
          composer install --prefer-dist
          composer clear-cache
          # rights
          chown -R www-data:www-data /app/mailer/vendor
          chown www-data:www-data /app/mailer/composer*
        args:
          chdir: /app/mailer
---
image: {{ .project }}-mailer-nginx-{{ .env }}
from: nginx:stable-alpine
docker:
  WORKDIR: /app/mailer
  USER: root
  EXPOSE: "80"
  ENTRYPOINT: ["/docker-entrypoint.sh"]

git:
  - url: git@gitlab.mcnloc.ru:stat/mailer.git
    branch: master
    herebyIAdmitThatBranchMightBreakReproducibility: true
    add: /
    to: /app/mailer
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: "Nginx 1. Utils"
      shell: |
        apk add net-tools mc vim telnet iputils-ping
        apk add busybox-extras
        # www-data:www-data -> 509:509
        # as jenkins:jenkins on tiberis
        # and as nginx:nginx on nginx container in the POD
        #apk --no-cache add shadow

{{ end }}
{{- end }}
################################## DEV ENVIRONMENT ###########################################################
{{ if (eq .env "dev") }}
---
image: {{ .project }}-mysql8-dev
from: mysql:8.0.25

git:
  - add: /migrations/migrations/data/m100000_000001_init/nispd.sql
    to: /root/nispd.sql

ansible:
  beforeInstall:
    - name: "install utils"
      shell: |
        apt-get update
        apt-get install -y \
                    vim \
                    mc
  setup:
    - name: "entrypoint"
      shell:
        cmd: |
          cat > /root/entry.sh << EOF
          #!/bin/bash -x
          docker-entrypoint.sh mysqld &
          mysqld_pid=\$!
          until mysqlcheck -u\$MYSQLDB_USER -p\$MYSQLDB_PASSWORD mysql; do sleep 2; done;

          if [[ \$(mysql mysql -e "show databases like 'nispd'" | grep nispd | wc -l) -eq '0' ]]; then
            /bin/bash /root/00-init-db.sh
            mysql -e '\. /root/nispd.sql'
            /bin/bash /root/01-set-000001-migration.sh
          fi


          date > /tmp/healthy
          kill -9 \$mysqld_pid
          docker-entrypoint.sh mysqld
          EOF
          chmod +x /root/entry.sh
#docker:
#  CMD: ["/bin/sleep","infinity"]
#  EXPOSE: "3306"
{{ end }}
{{ if (eq .env "dev-disabled") }}
---
image: {{ .project }}-pgdb-dev
from: postgres:12.3
#git:
#  - add: /install/db/SQL/init.sql
#    to: /docker-entrypoint-initdb.d/init.sql
---
image: {{ .project }}-dev
from: centos/systemd

docker:
  WORKDIR: /root
  USER: root
  ENV:
    MYSQL_DB: nispd
    MYSQL_HOST: mysql
    MYSQL_USER: stat
    MYSQL_PASSWORD: stat
    POSTGRES_DB: nispd
    POSTGRES_HOST: postgres
    POSTGRES_USER: stat
    POSTGRES_PASSWORD: stat
  # LC_ALL: en_US.UTF-8
  CMD: ["/usr/sbin/init"]
  EXPOSE: "80 8080"

git:
  - add: /
    to: {{ .ci_dir_home }}/stat
    stageDependencies:
      setup:
        - "**/composer.*"

ansible:
  beforeInstall:
    - name: 1
      shell: |
        yum install -y epel-release
        yum install -y wget vim
        yum install -y telnet
        yum install -y unzip net-tools mc
        yum install -y nano
        yum -y install curl
        yum -y update
        yum install -y nginx cronie
        yum -y update && yum -y upgrade
        yum install -y mysql
        yum install -y http://rpms.remirepo.net/enterprise/remi-release-7.rpm
        yum -y update && yum -y upgrade
        yum-config-manager --enable remi-php74
        yum install -y php php-fpm php-cli php-curl php-gd php-json php-zip php-mcrypt php-mysqlnd php-pgsql php-readline php-xmlrpc php-intl php-mbstring php-bcmath php-xmlwriter php-process php-pecl-redis php-pecl-amqp php-pecl-xdebug php-pecl-ssh2 php-soap
        yum clean all
        mkdir /run/php-fpm/
        touch /run/php-fpm/php-fpm.pid
        mkdir -p /var/lib/php/session
        chmod 777 /var/lib/php/session
  install:
    - name: 2
      shell: |
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer
        composer self-update --1
        composer global require "fxp/composer-asset-plugin"
        cd {{ .ci_dir_home }}/stat
        cp stat/local.conf.php.tpl stat/local.conf.php
        chmod -R 777 runtime
        chmod 777 web/assets
        mkdir stat/design_c
        chmod 777 stat/design_c
      args:
        chdir: {{ .ci_dir_home }}/stat
  setup:
    - name: 3
      shell: |
        composer install --prefer-dist
        composer clear-cache
      args:
        chdir: {{ .ci_dir_home }}/stat

{{ end }}
