<link href="lib/select2/select2.css" rel="stylesheet"/>
<script src="lib/select2/select2.js"></script>

<h1>
    <small>
        <a href="?module=voipnew&action=pricelist_report_list&report_type_id={$rep->report_type_id}">Отчеты</a>
    </small>

    Отчет: Сравнение операторов:
    <small>{if $rep->instance_id}{$regions[$rep->instance_id].name}{else}Все регионы{/if}

    (  {foreach from=$rep->pricelist_ids key='i' item='pl'}
    {if $i > 0},{/if}
    {$pricelists[$pl].operator}
    {/foreach})
    </small>
</h1>

<p>
  {if $volume.calc_date}
  Объемы звонков рассчитаны с {$volume.date_from} по {$volume.date_to}  ({if $volume.region_id}{$regions[$volume.region_id].name}{else}Все регионы{/if})
  {if $volume.need_recalc == 't'}
  <b>(требуется пересчет)</b>
  {/if}
  {else}
  Объемы не рассчитаны
  {/if}
  {if $volume.calc_running == 't'}
  <b>(идет расчет)</b>
  {else}
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <a href="?module=voipnew&action=calc_volume&report_type=pricelist&report_id={$rep->id}"">Рассчет объемов</a>
  {/if}

  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

  <a href="?module=voipnew&action=pricelist_report_edit&id={$rep->id}">Настройка отчета</a>
</p>

{if $rep->generated_at}
<p>
  Отчет расчитан {$rep->generated_at}
</p>
{/if}

<style type="text/css">
{literal}
td.best {
  background-color:rgb(153, 247, 153);
}
tr.lock td {
  background-color: #ff8888;
}
{/literal}
</style>

<form action="./index.php" method="get" style="display:inline">
	<input type="hidden" name="module" value="voipnew" />
	<input type="hidden" name="action" value="pricelist_report_show" />
	<input type="hidden" name="id" value="{$report_id}" />
	<select name="f_dest_group">
	<option value="-1" {if $f_dest_group eq '-1'} selected{/if}>-- Все направления --</option>
	<option value="1" {if $f_dest_group eq '1'} selected{/if}>Россия</option>
	<option value="2" {if $f_dest_group eq '2'} selected{/if}>Международка</option>
	<option value="3" {if $f_dest_group eq '3'} selected{/if}>СНГ</option>
	</select>
	<select name="f_country_id" class="select2" style="width: 250px">
	<option value="0">-- Все страны --</option>
	{foreach from=$geo_countries item='g'}
	<option value="{$g.id}" {if $g.id eq $f_country_id} selected{/if}>{$g.name}</option>
	{/foreach}
	</select>
	<select name="f_region_id" class="select2" style="width: 300px">
	<option value="0">-- Все регионы --</option>
	{foreach from=$geo_regions item='g'}
	<option value="{$g.id}" {if $g.id eq $f_region_id} selected{/if}>{$g.name}</option>
	{/foreach}
	</select>

    <select name="f_mob">
        <option value="0">-- Моб/Стац --</option>
        <option value="t" {if $f_mob eq 't'} selected{/if}>Мобильные</option>
        <option value="f" {if $f_mob eq 'f'} selected{/if}>Стационарные</option>
    </select>

    <br/>
  <input type="text" name="f_prefix" value="{$f_prefix}" placeholder="-- Префикс --"/>
  <input type="text" name="f_volume" value="{$f_volume}" placeholder="-- Объем --"/>
  &nbsp;&nbsp;&nbsp;&nbsp;
    <input type=submit name="make" id="make_report" value="Сформировать"/>
    <input type=submit name="calc" value="Пересчитать"/>
    <input type=submit name="export" value="Экспорт CSV"/>
</form>

<table class=price cellSpacing=2 cellPadding=4 border=0>
<tr>
  <td nowrap class=header style="min-width: 100px;">Префикс номера</td>
  <td class=header style="min-width: 100px;">Назначение</td>
  <td nowrap colspan="4" class=header align=center style="text-align: center">Итого<br/>Факт. Стоимость / Кол-во / Объем / Стоимость</td>
  {foreach from=$rep->pricelist_ids item='p'}
    <td nowrap colspan="4" class=header align=center style="text-align: center">{$pricelists[$p].operator}<br/>Цена / Кол-во / Объем / Стоимость</td>
	{/foreach}
</tr>

{foreach from=$report item='rd'}
{assign var='best_p' value=$rd.pricelists[0]}
<tr class="{cycle values='even,odd'} {if $rd.locked=='t'}lock{/if} " value="{$rd.locked}">
  <td>{$rd.prefix}</td>
  <td>{$rd.destination}{if $rd.mob=='t'} (mob){/if}</td>
  <td nowrap align=center style="min-width: 50px;">{$rd.amount_op}</td>
  <td nowrap align=center style="min-width: 50px;">{$rd.count}</td>
  <td nowrap align=center style="min-width: 50px;">{$rd.volume}</td>
  <td nowrap align=center style="min-width: 50px;">{$rd.amount_op}</td>
  {foreach from=$rep->pricelist_ids key='i' item='p'}
    <td nowrap align=center style="min-width: 50px;" class="{if $best_p==$p}best{/if}">{if $rd.parts[$i].price != 'NULL'}{$rd.parts[$i].price|replace:'.':','}{/if}</td>
    <td nowrap align=center style="min-width: 50px;" class="{if $best_p==$p}best{/if}">{$rd.parts[$i].count}</td>
    <td nowrap align=center style="min-width: 50px;" class="{if $best_p==$p}best{/if}">{$rd.parts[$i].volume}</td>
    <td nowrap align=center style="min-width: 50px;" class="{if $best_p==$p}best{/if}">{$rd.parts[$i].amount}</td>
  {/foreach}
</tr>
{/foreach}

<tr>
  <td><b>ИТОГО:</b></td>
  <td>&nbsp;</td>
  <td nowrap align=center><b>{$totals.all.amount_op}</b> р.</td>
  <td nowrap align=center><b>{$totals.all.count}</b></td>
  <td nowrap align=center><b>{$totals.all.volume}</b> м.</td>
  <td nowrap align=center><b>{$totals.all.amount}</b> р.</td>
  {foreach from=$rep->pricelist_ids key='i' item='p'}
  <td nowrap align=center>&nbsp;</td>
  <td nowrap align=center><b>{$totals[$i].count}</b></td>
  <td nowrap align=center><b>{$totals[$i].volume}</b> м.</td>
  <td nowrap align=center><b>{$totals[$i].amount}</b> р.</td>
  {/foreach}
</tr>
</table>

<script type="text/javascript">
    {literal}
    $(document).ready(function(){
        $('.select2').select2();
    });
    {/literal}
</script>
