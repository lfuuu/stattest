<script language="JavaScript" type="text/javascript" src="js/json2.js"></script>
<link href="css/themes/smoothness/jquery.ui.all.css" rel="stylesheet" type="text/css"/>
<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
<h1>{if $report_id==0}Новый отчет{else}Изменить отчет{/if}</h1>
<script type="text/javascript">
{literal}
function addpricelist(){
	var pricelist_id = $('#newpricelist')[0].value;
	if (pricelist_id == '') return;

	conf = { pricelist_id: pricelist_id, date1: new Date(), date2:'' };
	add_selprice_line(conf);
}
function add_selprice_line(conf){
	var tr = $('<tr class="even">');
	tr[0]._conf = conf;
	var name = $("#newpricelist option[value='"+conf.pricelist_id+"']").text();
	tr.append($('<td>'+name+'</td>'));
	var date;var btncl;
	var n = $('#selprices tr').length;
	date = $('<input readonly type=text value=""/>').datepicker().datepicker('setDate', conf.date1);
	btncl = $('<a href="#" onclick="this.date.datepicker(\'setDate\',\'\');return false">[x]</a>')
	btncl[0].date = date;
	tr[0]._conf.datepicker1 = date;
	tr.append($('<td>').append('<i>f'+n+':</i> ').append(date).append(btncl));
	date = $('<input readonly type=text value=""/>').datepicker().datepicker('setDate', conf.date2);
	btncl = $('<a href="#" onclick="this.date.datepicker(\'setDate\',\'\');return false">[x]</a>')
	btncl[0].date = date;
	tr[0]._conf.datepicker2 = date;
	tr.append($('<td>').append('<i>f'+n+'n:</i> ').append(date).append(btncl));

	var btndel = $('<a href="#" onclick="this.tr.remove();return false">Удалить</a>')
	btndel[0].tr = tr;
	tr.append($('<td>').append(btndel));
	$('#selprices').append(tr);
}
function addcalcfield(){

	conf = { name: 'new field', formula: '' };
	add_calcfield_line(conf);
}
function add_calcfield_line(conf){
	var tr = $('<tr class="even">');
	tr[0]._conf = conf;
	var name, formula;
	name = $('<input type=text />');
	name[0].value = conf.name;
	tr[0]._conf.fname = name;
	tr.append($('<td valign=top>').append(name));
	formula = $('<textarea cols=80 rows=5 />');
	formula.text(conf.formula);
	//formula = $('<input type=text />');
	//formula[0].value = conf.formula;
	tr[0]._conf.fformula = formula;
	tr.append($('<td>').append(formula));

	var btndel = $('<a href="#" onclick="this.tr.remove();return false">Удалить</a>')
	btndel[0].tr = tr;
	tr.append($('<td>').append(btndel));
	$('#calcfields').append(tr);
}
function report_save(){	
	var data = { selprices: [], calcfields: [] };
	var mtr = $('#selprices tr.even');
	for (var i=0; i<mtr.length; i++){
		var obj = { pricelist_id: mtr[i]._conf.pricelist_id };
		obj.date1 = mtr[i]._conf.datepicker1[0].value; //.datepicker('getDate');
		obj.date2 = mtr[i]._conf.datepicker2[0].value; //datepicker2.datepicker('getDate');
		data.selprices.push(obj);
	}
	var mtr = $('#calcfields tr.even');
	for (var i=0; i<mtr.length; i++){
		var obj = { pricelist_id: mtr[i]._conf.pricelist_id };
		obj.name = mtr[i]._conf.fname[0].value; //.datepicker('getDate');
		obj.formula = mtr[i]._conf.fformula[0].value; //datepicker2.datepicker('getDate');
		data.calcfields.push(obj);
	}
	$('#data')[0].value = JSON.stringify(data);
	$('#editreport')[0].submit();
}
function calc_volumes(report_id){
	var from = $('#volumes_from')[0].value;
	var to = $('#volumes_to')[0].value;
	if (from == '' || to == '') { alert('Укажите дату рассчета объема звонков'); return; }
	
	window.location='index.php?module=voipnew&action=analyze_pricelist_report_calc_volumes&id='+report_id+'&from='+from+'&to='+to;
}
$(document).ready(function(){
  $.datepicker.regional.ru = {
			closeText: 'Закрыть',
			prevText: '&#x3c;Пред',
			nextText: 'След&#x3e;',
			currentText: 'Сегодня',
			monthNames: ['Январь','Февраль','Март','Апрель','Май','Июнь',
			'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'],
			monthNamesShort: ['Янв','Фев','Мар','Апр','Май','Июн',
			'Июл','Авг','Сен','Окт','Ноя','Дек'],
			dayNames: ['воскресенье','понедельник','вторник','среда','четверг','пятница','суббота'],
			dayNamesShort: ['вск','пнд','втр','срд','чтв','птн','сбт'],
			dayNamesMin: ['Вс','Пн','Вт','Ср','Чт','Пт','Сб'],
			weekHeader: 'Не',
			dateFormat: 'dd.mm.yy',
			firstDay: 1,
			showMonthAfterYear: false,
			yearSuffix: ''};
		$.datepicker.setDefaults($.datepicker.regional.ru);
		
		$('#volumes_from').datepicker();
		$('#volumes_to').datepicker();
		var data = JSON.parse($('#data')[0].value);
		for(var i = 0; i < data.selprices.length;i++){
			add_selprice_line(data.selprices[i]);
		}
		for(var i = 0; i < data.calcfields.length;i++){
			add_calcfield_line(data.calcfields[i]);
		}
				
	});
{/literal}
</script>
<form id="editreport" method="POST" >
<input type=hidden id='data' name='data' value='{$data}' />
<input type=hidden id="report_id" name='report_id' value='{$report_id}' />
Добавить прайс:
<select id="newpricelist" name="newpricelist">
	<option value="">--- выберите прайслист --- </option>
	{foreach from=$pricelists item='r'}
	<option value="{$r.pricelist_id}">{$r.operator} / {$r.pricelist} / {$r.group} / {$r.currency}</option>
	{/foreach}
</select>
<input type="button" value="Добавить" onclick="addpricelist()">
<br/><br/>
Выбранные прайсы:

<table id="selprices" class=price cellSpacing=2 cellPadding=4 border=0>
	<tr>
		<td class=header>Прайслист</td><td class=header>Дата 1</td><td class=header>Дата 2</td><td class=header>&nbsp;</td>
	</tr>
</table>
<br/><br/>
Вычисляемые поля:
<input type="button" value="Добавить" onclick="addcalcfield()"><br/>
<table id="calcfields" class=price cellSpacing=2 cellPadding=4 border=0>
	<tr>
		<td class=header>Наименование</td><td class=header>Формула</td><td class=header>&nbsp;</td>
	</tr>
</table>
<br/><br/>
<input type=button value="Сохранить" onclick="report_save()" />
</form>