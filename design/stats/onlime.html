<script src="js/jquery.js"></script>
<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
<script src="js/ui/i18n/jquery.ui.datepicker-ru.js"></script>
<link href="css/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css"/>

<h2>Отчет. {$client_name} {$date}</h2>
{if false}
<div style="text-align: right; padding-right: 100px;">
<a href="./?{if $viewLink}module=stats&action={$report}{/if}&do=add">Создать заявку</a>
</div>
{/if}
<style>
{literal}
#repart_table td {
    padding: 2px 2px 2px 2px;
    font: normal 8pt sans-serif;
}
#tr_head td {
    font-weight: bold;
    text-align: center;
}
.ui-datepicker {
	font-size: 10px;
}
{/literal}
</style>
{if $showSelects}
<form action="" method=get>
	<input type="hidden" name="module" value="stats" />
	<input type="hidden" name="action" value="{$report}" />
	{if false}
	<table>
		<tr>
			<td>С</td>
			<td><select name="date_from_y1" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y1','date_from_m1','date_from_d1')">{generate_sequence_options_select start=2003 selected=$date_from_y1}</select></td>
			<td><select name="date_from_m1" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y1','date_from_m1','date_from_d1')">{generate_sequence_options_select start=1 end=12 mode='m' selected=$date_from_m1}</select></td>
			<td><select name="date_from_d1" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y1','date_from_m1','date_from_d1')">{generate_sequence_options_select start=1 end=31 mode='d' selected=$date_from_d1}</select></td>
			<td>&nbsp;</td>
			<td>по</td>
			<td><select name="date_to_y1" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y1','date_to_m1','date_to_d1')">{generate_sequence_options_select start=2003 selected=$date_to_y1}</select></td>
			<td><select name="date_to_m1" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y1','date_to_m1','date_to_d1')">{generate_sequence_options_select start=1 end=12 mode='m' selected=$date_to_m1}</select></td>
			<td><select name="date_to_d1" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y1','date_to_m1','date_to_d1')">{generate_sequence_options_select start=1 end=31 mode='d' selected=$date_to_d1}</select></td>
            <td><input type=submit value="OK"></td>
		</tr>
    </table>
    {/if}
    <table>
    	<tr>
    		<td>C </td>
    		<td><input type=text value="{$date_from}" id=date_from name=date_from></td>
    		<td>по </td>
    		<td><input type=text value="{$date_to}"  id=date_to name=date_to></td>
    		<td><input type=submit value="OK"></td>
    	</tr>
    </table>
<script>
{literal}

$('#date_from').datepicker({
	dateFormat: 'yy-mm-dd',
    onClose: function(dateText, inst) {
        var endDateTextBox = $('#date_to');
        if (endDateTextBox.val() != '') {
            var testStartDate = new Date(dateText);
            var testEndDate = new Date(endDateTextBox.val());
            if (testStartDate > testEndDate)
                endDateTextBox.val(dateText);
        }
        else {
            endDateTextBox.val(dateText);
        }
    },
    onSelect: function (selectedDateTime){
        var start = $(this).datepicker('getDate');
        $('#date_to').datepicker('option', 'minDate', new Date(start.getTime()));
    }
});

$('#date_to').datepicker({
	dateFormat: 'yy-mm-dd',
    onClose: function(dateText, inst) {
        var startDateTextBox = $('#date_from');
        if (startDateTextBox.val() != '') {
            var testStartDate = new Date(startDateTextBox.val());
            var testEndDate = new Date(dateText);
            if (testStartDate > testEndDate)
                startDateTextBox.val(dateText);
        }
        else {
            startDateTextBox.val(dateText);
        }
    },
    onSelect: function (selectedDateTime){
        var end = $(this).datepicker('getDate');
        $('#date_from').datepicker('option', 'maxDate', new Date(end.getTime()) );
    }
});

{/literal}
</script>
    </form>
{/if}
<table border=1 style="border-collapse:collapse; width: 300px;text-align:center;">
<tr><td><b>В Обработке</b></td><td>{if $s.work}{$s.work}{else}0{/if}</td><td><a href="./?{$url}&list=work">Посмотреть&raquo;</a></td></tr>
<tr><td><b>Достaвлен</b></td><td>{if $s.close}{$s.close}{else}0{/if}</td><td><a href="./?{$url}&list=close">Посмотреть&raquo;</a></td></tr>
<tr><td><b>Отказ</b></td><td>{if $s.reject}{$s.reject}{else}0{/if}</td><td><a href="./?{$url}&list=reject">Посмотреть&raquo;</a></td></tr>
<tr><td><b>Возврат</b></td><td>{if $s.rollback}{$s.rollback}{else}0{/if}</td><td><a href="./?{$url}&list=rollback">Посмотреть&raquo;</a></td></tr>
</table><br>
{if $list}
<h2>{$listName}</h2>
<div style="text-align: right;"><a href="./?{$url}&list={$listType}&export=excel">Экспорт в Excel</a></div>
<table id=repart_table border=1 style="border-collapse: collapse;" cellspacing=2 >
<tr id="tr_head">
<td rowspan=2 width=1%>#</td>
<td rowspan=2 width=10%>Оператор</td>
<td rowspan=2 width=10%>Номер счета</td>
<td rowspan=2 width=10%>Дата<br>создания заказа</td>
<td colspan=3 width=1%>Кол-во</td>
<td rowspan=2 width=10%>Серийный номер</td>
<td rowspan=2 width=10%>ФИО клиента</td>
<td rowspan=2 width=10%>Телефон клиента</td>
<td rowspan=2 width=20%>Адрес</td>
<td colspan=2 width=10%>Дата доставки</td>
<td rowspan=2 width=20%>Этапы</td>
</tr>
<tr>
<td>TeleCARD</td>
<td>HD-ресивер</td>
<td>НВ-р. с диском</td>
<td>Желаемая</td>
<td>Фактическая</td>
</tr>

{foreach from=$list item=i key=idx}
<tr>
<td>{$idx+1}.</td>
<td>{$i.fio_oper}</td>
<td>{if $viewLink}<a href="./?module=newaccounts&action=bill_view&bill={$i.bill_no}">{/if}{$i.bill_no}{if $viewLink}</a>{/if}{if $i.fio_oper != 'onlime_shop'}&nbsp;<a href="./?{if $viewLink}module=stats&action={$report}{/if}&do=edit&bill_no={$i.bill_no}"><img src="./images/icons/edit.gif" border=0 align=absmiddle></a>{/if}</td>
<td>{$i.date_creation}</td>
<td align=center>{$i.count_3|round:0}</td>
<td align=center>{$i.count_9|round:0}</td>
<td align=center>{$i.count_11|round:0}</td>
<td>{$i.serials|replace:",":",<br>"}</td>
<td>{$i.fio}</td>
<td>{$i.phone}</td>
<td>{$i.address}</td>
<td>{$i.date_deliv}</td>
<td>{$i.date_delivered|substr:0:-3}</td>
<td>
<div id="d_{$idx}" style="display:none;" title="Заказ {$i.bill_no}">
{include file='stats/onlime_stage.tpl' i_stages=$i.stages last=100}
</div>
{include file='stats/onlime_stage.tpl' i_stages=$i.stages last=2}
{if count($i.stages) > 2}
    <div style="cursor: pointer; color: blue;" class="to_view" id="t_{$idx}">Посмотреть всю историю</div>
{/if}
</td>
</tr>
{/foreach}
</table>
<script>
{literal}

$("div.to_view").click(function(e){
    $("#"+e.srcElement.id.replace("t_", "d_")).dialog();
})

{/literal}
</script>
{/if}
