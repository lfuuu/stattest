<center><h1>Пересчет звонков клиента {$client}</h1></center>

<form action="" method="get">
	<input type="hidden" name="module" value="stats" />
	<input type="hidden" name="action" value="recalcalls" />
	<table>
		<tr>
			<td>Дата</td>
			<td><select name="date_from_y" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y','date_from_m','date_from_d')">{generate_sequence_options_select start=2003 selected=$checks.dates.from_y}</select></td>
			<td><select name="date_from_m" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y','date_from_m','date_from_d')">{generate_sequence_options_select start=1 end=12 mode='m' selected=$checks.dates.from_m}</select></td>
			<td><select name="date_from_d" onchange="optools.friendly.dates.check_mon_right_days_count('date_from_y','date_from_m','date_from_d')">{generate_sequence_options_select start=1 end=31 mode='d' selected=$checks.dates.from_d}</select></td>
			<td>&nbsp;</td>
			<td><select name="date_to_y" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y','date_to_m','date_to_d')">{generate_sequence_options_select start=2003 selected=$checks.dates.to_y}</select></td>
			<td><select name="date_to_m" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y','date_to_m','date_to_d')">{generate_sequence_options_select start=1 end=12 mode='m' selected=$checks.dates.to_m}</select></td>
			<td><select name="date_to_d" onchange="optools.friendly.dates.check_mon_right_days_count('date_to_y','date_to_m','date_to_d')">{generate_sequence_options_select start=1 end=31 mode='d' selected=$checks.dates.to_d}</select></td>
		</tr>
		<tr>
			<td>Подключения</td>
			<td colspan="7">
				<select name="conns[]" multiple="multiple" size="{$conns_count}">
				{foreach from=$conns item='c'}
				<option value="{$c.id}"{if in_array($c.id,$checks.conns) || ($checks.first && $c.active)} selected='selected'{/if}>{$c.e164} ({$c.id}, {$c.no_of_lines}, {$c.actual_from} - {$c.actual_to})</option>
				{/foreach}
				</select>
			</td>
		</tr>
		<tr><td colspan="8" style="text-align: center"><input type="submit" name="step1" value="OK" /></td></tr>
	</table>
</form>
{if isset($step) && $step==1}
<form action="" method="post">
<input type="hidden" name="month" value="{$month}" />
<table border="1">
	{foreach from=$calls key='usage_id' item='ucalls'}
	<tr>
		<td colspan="8">
			<input type="hidden" name="u_{$usage_id}_freesec" value="{$ucalls.free.diftime}" />
			<input type="hidden" name="u_{$usage_id}_addsum" value="{$ucalls.free.difsum}" />
			Подключение: {$usage_id}<br />
			Номер телефона: {$connections[$usage_id].e164}<br />
			Количество линий: {$connections[$usage_id].no_of_lines}<br />
			Время действия: {$connections[$usage_id].actual_from} - {$connections[$usage_id].actual_to}<br />
			Количество бесплатных секунд: {$connections[$usage_id].free_sec}<br />
			Использовано бесплатных секунд: {$connections[$usage_id].msk_length} / {$ucalls.free.retime}<br />
			Сумма разговоров: {$connections[$usage_id].all_cost} / {$ucalls.free.resum|round:2} = {$ucalls.free.difsum|round:2}<br />
			Валюта:	{if $connections[$usage_id].currency=='RUR'}рубли{else}usd{/if}<br />
			Количество звонков с новой тарификацией: {$ucalls.free.recalc_count}
		</td>
	</tr>
	<tr>
		<td>Идентификатор разговора</td>
		<td>Длина разговора</td>
		<td>Телефон</td>
		<td>Дата и время</td>
		<td>Сумма разговора</td>
		<td>DEF код</td>
		<td>Направление, группа</td>
		<td>Направление, подгруппа</td>
	</tr>
	{foreach from=$ucalls key='uid' item='call'}{if $uid<>'free'}
	<tr>
		<td>
			<input type="hidden" name="s_{$uid}_flag" value="{$call.flag}" />
			{$call.id}
		</td>
		<td>{$call.lengthresult}</td>
		<td>{$call.phone}</td>
		<td>{$call.date}</td>
		<td>
			<input type="hidden" name="s_{$uid}_sum" value="{$call.newsum}" />
			{$call.tarif_sum} / {$call.newsum}
		</td>
		<td>
			<input type="hidden" name="s_{$uid}_def" value="{$call.newdef}" />
			{$call.def} / {$call.newdef}
		</td>
		<td>
			<input type="hidden" name="s_{$uid}_dgroup" value="{$call.newdgroup}" />
			{if $call.dgroup==0}Москва{elseif $call.dgroup==1}Россия{elseif $call.dgroup==3}Международное{else}{$call.dgroup}{/if}
			/
			{if $call.newdgroup==0}Москва{elseif $call.newdgroup==1}Россия{elseif $call.newdgroup==3}Международное{else}{$call.newdgroup}{/if}
		</td>
		<td>
			<input type="hidden" name="s_{$uid}_dsubgroup" value="{$call.newdsubgroup}" />
			{if $call.dsubgroup==0}
				Мобильные
			{elseif $call.dsubgroup==1}
				Стационарные/1 зона
			{elseif $call.dsubgroup==99}
				Другие
			{elseif $call.dsubgroup==98}
				Россия Фрифон
			{elseif $call.dsubgroup==97}
				Международное Фрифон
			{else}
				{$call.dsubgroup} зона
			{/if}
			/
			{if $call.newdsubgroup==0}
				Мобильные
			{elseif $call.newdsubgroup==1}
				Стационарные/1 зона
			{elseif $call.newdsubgroup==99}
				Другие
			{elseif $call.newdsubgroup==98}
				Россия Фрифон
			{elseif $call.newdsubgroup==97}
				Международное Фрифон
			{else}
				{$call.newdsubgroup} зона
			{/if}
		</td>
	</tr>
	{/if}{/foreach}
	{/foreach}
	<tr><td colspan="8" style="text-align: center;"><input type="submit" name="step2" value="Go!" /></td></tr>
</table>
</form>
{/if}
{if isset($step) && $step==2}
<h2 style="color:red">{$message}</h2>
{/if}